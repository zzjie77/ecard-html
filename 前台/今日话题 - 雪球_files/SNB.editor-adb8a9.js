define("SNB.editor.js",["lib/store","SNB.editor.emotion","lib/autoresize","lib/upload","SNB.pdfDialog","lib/ueditor","editor_inline.css.js","editor.jade.js","editor-footer.jade.js"],function(e,t){function o(e){S.off("resize.fullEditor").on("resize.fullEditor",function(){e.setMinFrameHeight()})}function n(e,t){var o=S.scrollLeft(),n=S.scrollTop(),i=t.find(">iframe").offset(),a=e.getCursorPosition(),r={start:{},end:{}};return r.start.x="number"==typeof a.start.x?a.start.x+i.left-o:void 0,r.start.y="number"==typeof a.start.y?a.start.y+i.top-n:void 0,r.end.x="number"==typeof a.end.x?a.end.x+i.left-o:void 0,r.end.y="number"==typeof a.end.y?a.end.y+i.top-n:void 0,r}function i(e){function t(){var e=i().range;e.deleteContents().insertNode(e.document.createTextNode(s.find(".selected").text())).collapse(),o(e),u.hide()}function o(e){var t,o,n,i=e.cloneRange(),a=$.browser.msie?" ":" ";for(t=e.endOffset;o=e.endContainer.childNodes[t++];){if(1===o.nodeType){if(o.tagName.match(/span/i)&&o.id.match(/^_baidu_bookmark_/))continue;if(x.isEmptyNode(o))continue;if(o.tagName.match(/span|strong|b/i)){i.selectNode(o).shrinkBoundary(!0),o=i.startContainer.childNodes[0];break}break}if(3!==o.nodeType||o.nodeValue.length)break}n=o&&3===o.nodeType&&o.nodeValue.charCodeAt(0),32===n||160===n?e.setStart(o,1).collapse(!0):e.insertNode(e.document.createTextNode(a)).collapse(),e.select(!0)}function n(e,t){var o;return e in T&&T[e]instanceof Array?t(T[e]):(o=v.get("at:"+e))&&(new Date).valueOf()-o.updatedAt<6e5?(T[e]=o.names,t(o.names)):void SNB.get("/users/autocomplete.json",{q:e,count:8},function(o){T[e]=o.names,o.names&&o.names instanceof Array&&v.set("at:"+e,{updatedAt:(new Date).valueOf(),names:o.names}),t(T[e])})}function i(){{var t,o,n=u.is(":visible"),i=e.editor.selection.getRange(),a=i.startContainer,r=i.startOffset;$(a.parentNode)}if(3!=a.nodeType){if(1!=a.nodeType||1!=i.endContainer.nodeType||!r||r!=i.endOffset||3!=a.childNodes[r-1].nodeType)return n&&u.hide();var s=a.childNodes[r-1];i.setStart(s,s.nodeValue.length).collapse(!0),a=i.startContainer,r=i.startOffset}var d=i.getCommonAncestor();if(3!=d.nodeType&&d!=a.parentNode)return n&&u.hide();var t=$(i.cloneContents()).text()||"";if(t&&t.match(/[^a-zA-Z0-9_\-\u4e00-\u9fa5\u200B]/))return n&&u.hide();var o,l,c,p,f;if(o=x.getNodeIndex(a),l=a.nodeValue.substring(0,r),p=l.lastIndexOf("@"),f=l.match(/[^@a-zA-Z0-9_\-\u4e00-\u9fa5\u200B][a-zA-Z0-9_\-\u4e00-\u9fa5\u200B]*$/),f&&p<f.index)return n&&u.hide();if(p>=0)i.setStart(a,p+1),l=l.substring(p+1);else{for(;--o>=0&&l.length<=30;){if(c=a.parentNode.childNodes[o],3!=c.nodeType){if(4==c.nodeType)continue;break}if(l=c.nodeValue+l,p=l.lastIndexOf("@"),f=l.match(/[^@a-zA-Z0-9_\-\u4e00-\u9fa5\u200B][a-zA-Z0-9_\-\u4e00-\u9fa5\u200B]*$/),f&&p<f.index+1)return n&&u.hide();if(p>=0){i.setStart(c,p+1),l=l.substring(p+1);break}}if(0>p)return n&&u.hide()}return l=l||"",t=(l+t).replace(/\u200B/g,""),t.length>30?n&&u.hide():{success:!0,range:i,text:t,start:l.length,end:t.length}}function a(){if(c)return c=!1;var e=i();if(e.success){var o=e.range,a=e.text,p=e.start,f=e.end;o.deleteContents();var m=o.document.createElement("span"),h=d.offset();if(m.style.cssText="width:0px;overflow:hidden;margin:0;padding:0;border:0;",m.appendChild(o.document.createTextNode(a?a:"​")),o.insertNode(m),pos=x.getXY(m),pos.x+=h.left-10,pos.y-=d.find("iframe").contents().scrollTop(),$.browser.msie?pos.y+=h.top+(l?23:B()?22:30):(pos.y+=h.top+(l?19:B()?21:27),$.browser.mozilla&&(pos.y+=2)),o.deleteContents(),a){var g=o.document.createTextNode(a);o.insertNode(g).setStart(g,p).setEnd(g,f).select(!0)}r.text(a?"选择想@的人或敲空格完成输入":"输入昵称或选择经常@的人"),s.empty().append('<li class="loading" style="width:136px;height:45px;background-color:#fff;cursor:default;"></li>'),u.css({left:pos.x,top:u.hasClass("arrow-down")?pos.y-u.height()-40:pos.y,opacity:1}).show().data("atSelect",t);var v,b;(v=$(".ui-dialog:visible",N)).length&&(b=v.css("z-index"))&&(b=parseInt(b,10))&&u.css("z-index",b+10),n(a,function(e){e.length||(e=[a]);var t="",o=-1;_.each(e,function(e){t+="<li"+(++o?"":' class="selected"')+">"+e+"</li>"}),s.empty().html(t),u.show();var n=u.height(),i=pos.y+n,r=S.height(),d=S.scrollTop(),l=r+d;i>l&&!B()?$("html,body").animate({scrollTop:Math.min(i-r+10,pos.y-72)},200):i>l&&pos.y-n-20>d?u.css({top:pos.y-n-40}).removeClass("arrow-up").addClass("arrow-down"):u.css({top:pos.y}).removeClass("arrow-down").addClass("arrow-up")})}}if(!e||e.atSelectionchange)return!1;e.atSelectionchange=!0;var r,s,d=e.$uew,l=e.$textarea&&e.$textarea.parent().is(".inputArea"),u=N.find("#editor-at-suggestion");u.length||(u=$('<div id="editor-at-suggestion" class="dropdown-menu arrow-up"><div class="hint">请输入</div><ul></ul></div>').hide().appendTo(N).on("click","li",function(e){$(e.target).siblings().removeClass("selected").end().addClass("selected"),u.data("atSelect")()}).on("mouseover","li",function(e){$(e.target).siblings().removeClass("selected").end().addClass("selected")}),$doc.on("click",function(){u.hide()})),s=u.find(">ul"),r=u.find(">.hint");var c;return e.editor.addListener("selectionchange",a),e.editor.addListener("keydown",function(o,n){var i,a,r,s,d,l=n.keyCode||n.which;if(27==l)u.is(":visible")&&(c=!0,u.hide());else if(229==l)u.is(":visible")&&(c=!0);else if(38==l)u.is(":visible")?(c=!0,n.preventDefault?n.preventDefault():n.returnValue=!1,s=$(".selected",u).prev(),s.length?($("li",u).removeClass("selected"),s.addClass("selected")):$("li",u).removeClass("selected").eq(-1).addClass("selected")):f(e);else if(40==l)u.is(":visible")&&(c=!0,n.preventDefault?n.preventDefault():n.returnValue=!1,d=$(".selected",u).next(),d.length?($("li",u).removeClass("selected"),d.addClass("selected")):$("li",u).removeClass("selected").eq(0).addClass("selected"));else if(13==l){if(n.preventDefault?n.preventDefault():n.returnValue=!1,n.ctrlKey)return;if(i=e.editor.selection.getRange(),u.is(":visible"))t();else if(i.collapsed){r=i.document.createElement("br"),i.insertNode(r);var p=r.parentNode;p.lastChild===r?(r.parentNode.insertBefore(r.cloneNode(!0),r),i.setStartBefore(r)):i.setStartAfter(r),i.setCursor()}else if(i.deleteContents(),a=i.startContainer,1==a.nodeType&&(a=a.childNodes[i.startOffset])){for(;1==a.nodeType;){if(w.dom.dtd.$empty[a.tagName])return i.setStartBefore(a).setCursor(),!1;if(!a.firstChild)return r=i.document.createElement("br"),a.appendChild(r),i.setStart(a,0).setCursor(),!1;a=a.firstChild}a===i.startContainer.childNodes[i.startOffset]?(r=i.document.createElement("br"),i.insertNode(r).setCursor()):i.setStart(a,0).setCursor()}else r=i.document.createElement("br"),i.insertNode(r).setStartAfter(r).setCursor()}}),function(t,o){var n=o.keyCode||o.which;(n>=49&&57>=n||32==n||13==n)&&a(),13==n&&setTimeout(function(){e.editor.selection.getRange().scrollToView(e.editor.autoHeightEnabled,e.editor.autoHeightEnabled?x.getXY(e.editor.iframe).y:0)},50)}}function a(e){return function(t){var o,i,a,r,s,d=e.editor?e.$uew:e.$textarea,l=$("body.editor-mode>.editor, body.main-editor-mode #main-editor>.editor"),u=l.length&&$(".editor-toolbar",l),c=(u&&l.parent().data("editor"),t.type);if("keyup"===c){if(52!==t.keyCode)return;if(e.editor){if(r=e.editor.selection.getRange(),index=r.startOffset,!r.collapsed)return;if(!index)return;if(3!==r.startContainer.nodeType)return;s=$.text(r.startContainer)}else s=e.textarea.value,index=e.getSelectionStart();if(!s||!s.match(/\$$/))return}u&&"keyup"===c?(i=n(r,e.$uew,!0).start,a=e.$uew.find(">iframe").offset().left-S.scrollLeft(),o=[i.x+10,i.y-46]):o=u?[window.innerWidth/2-120,u.hasClass("fixed")?0:u.offset().top-S.scrollTop()]:[d.offset().left-S.scrollLeft(),d.offset().top-S.scrollTop()+d.height()],SNB.Util.insertStock(o,function(t){e.insert(("keyup"===c?"":"$")+t.name+"("+t.value+")$ "),e.$textarea&&e.$textarea.hasClass("not-init")&&(e.$textarea.trigger("mouseup"),e.$textarea.removeClass("not-init"))})}}function r(e,t,o){var n="",i="";t.width&&(t.width>480?(i=' width="480" ',t.height&&(n=' height="'+Math.round(480*t.height/t.width)+'" ')):(i=' width="'+t.width+'" ',t.height&&(n=' height="'+t.height+'" ')));var a=t.url?t.url+"/"+t.filename+"!custom.jpg":SNB.domain.upyun+"/"+t.filename+"!custom.jpg",r='<p>​<img class="ke_img" src="'+a+'" '+i+n+j+"/></p>";setTimeout(function(){e.execCommand("insertHtml",r),e.autoHeightEnabled&&setTimeout(function(){e.adjustHeight()},100)},0),o&&o()}function s(e,t){var o=y(t,{action:"/service/upload_photo",type:["gif","png","jpg","jpeg"],accept:"image/*",sizeLimit:5120,flashSizeLimit:5120,timeout:3e4,flashTimeout:6e4,queueSizeLimit:10});o.on("upload.fail upload.done upload.success",function(){e.uploadStatusClear()}),o.on("upload.fail.ret upload.fail.unknown",function(){SNB.Util.failDialog("上传失败，请重试或换张图片试试",300,null,2e3)}),o.on("upload.fail.timeout",function(){SNB.Util.failDialog("上传超时，请确保图片小于5M",300,null,2e3)}),o.on("upload.fail.queue",function(){SNB.Util.failDialog("一次至多可以选取上传10张图片",300,null,2e3)}),o.on("upload.fail.limit",function(){SNB.Util.failDialog("请上传小于5M的图片",240)}),o.on("upload.fail.type",function(){SNB.Util.failDialog("只支持PNG，JPG，GIF格式图片",240)}),o.on("upload.success",function(t,o){e.insertImage(o)}),o.on("upload.started",function(){e.uploadStatusUploading()})}function d(e){if("number"==typeof e.selectionStart)return e.selectionStart;if(document.selection){var t=document.selection.createRange();if(!t)return 0;var o=e.createTextRange(),n=o.duplicate();return o.moveToBookmark(t.getBookmark()),n.setEndPoint("EndToStart",o),n.text.length}return 0}function l(e){if(e.selectionEnd)return e.selectionEnd;if(document.selection){var t=document.selection.createRange();if(!t)return 0;var o=e.createTextRange(),n=o.duplicate();return o.moveToBookmark(t.getBookmark()),n.setEndPoint("EndToEnd",o),n.text.length}return 0}function u(e,t,o){if(e.setSelectionRange)e.setSelectionRange(t,t+o);else if(document.selection){var n=e.createTextRange();n.collapse(!0),n.moveStart("character",t),n.moveEnd("character",o),n.select()}else e.selectionStart=t,e.selectionEnd=t+o}function c(e,t){if(!(this instanceof c))return new c(e,t);if("string"==typeof e)return new c($(e),t);if(e.data("ta"))return e.data("ta");var o=this;e=e.eq(0),o.$textarea=e,o.textarea=e[0],e.data("ta",o),$.browser.msie&&e.on("keyup keydown mouseup",function(){try{$(this).data("start",o.getSelectionStart()).data("end",o.getSelectionEnd())}catch(e){}}),e.on("paste",function(){setTimeout(function(){var e=o.textarea.value;(~e.indexOf("")||~e.indexOf(""))&&(o.setBookmark200B(),o.textarea.value=o.textarea.value.replace(/\uF0A7|\uF020/g,""),o.setSelection200B())},0)}),t=o.options={$emotion:t&&t.$emotion,$stock:t&&t.$stock,$upload:t&&t.$upload,$pdf:t&&t.$pdf,ctrlReturn:t&&t.ctrlReturn||!1,submitFunc:t&&t.submitFunc||function(){},insertFunc:t&&t.insertFunc||function(){},autoResize:t&&t.autoResize||!1,content:t&&t.content||""},t.ctrlReturn&&function(){o.$textarea.keydown(function(e){return e.ctrlKey&&13===e.keyCode?(t.submitFunc(),!1):void 0})}(),t.$emotion&&t.$emotion.length&&g(o,t.$emotion),t.$stock&&t.$stock.length&&(o.stockKeyup=a(o),o.$textarea.bind("keyup",o.stockKeyup),t.$stock.on("click",o.stockKeyup)),t.$upload&&t.$upload.length&&s(o,t.$upload),t.$pdf&&t.$pdf.on("click",k),o.$textarea.val(t.content),t.focus&&o.$textarea.focus(),t.autoResize&&(o.$textarea.css("min-height",t.autoResize),b(o.$textarea))}function p(e,t){var o=$(e.document),n=$.Deferred();return $.ajax({url:"/service/pasted_images",type:"POST",contentType:"application/json",data:JSON.stringify(t),dataType:"json",timeout:7e4,complete:function(t){if(200!=t.status)return n.resolve(2);var i,a,r;try{r=$.parseJSON(t.responseText)}catch(s){}if(!r||!$.isPlainObject(r))return n.resolve(2);var d,l;$.browser.msie&&(d=e.selection.getRange(),l=d.createBookmark()),_.each(r,function(e,t){var n,r,s=o.find("#"+t);e&&e.filename&&-1!=e.code?(n=parseInt(e.width,10),r=parseInt(e.height,10),80>n&&80>r?(s.remove(),e.same&&_.each(e.same,function(e){o.find("#"+e).remove()})):(s.attr({src:e.src,"class":"ke_img"}).removeAttr("width").removeAttr("height").removeAttr("id"),e.same&&_.each(e.same,function(t){var n=o.find("#"+t);n.attr({src:e.src,"class":"ke_img"}).removeAttr("width").removeAttr("height").removeAttr("id")}),a=!0)):(s.remove(),i=!0)}),$.browser.msie&&d.moveToBookmark(l),n.resolve(i?a?1:2:0)},error:function(){_.map(t,function(e){o.find("#"+e.id).remove(),e.same&&_.each(e.same,function(e){o.find("#"+e).remove()})}),n.resolve(2)}}),n.promise()}function f(e){return e.editor.autoHeightEnabled?void setTimeout(function(){var t=e.editor.selection.getRange(),o=t.collapsed?t.getCursorPosition().start.y:0,n=o&&S.scrollTop(),i=o&&S.height(),a=e.$uew.parent().is(".inputArea")?50:B()?40:44,r=e.$uew.offset().top;o&&a>o+r-n?S.scrollTop(o+r-a):B()&&o&&o+80-n>i-100&&S.scrollTop(o-i+181)},50):setTimeout(function(){e.editor.selection.getRange().scrollToView(!1,0)},50)}function m(){if(N.is("#my-home")){var e=$("#main-editor").data("ta");if(e&&e.hasContent()){var t=e.$uew.closest(".editor").find("input.title"),o=t.length&&t.val();if(e.editor){var n=e.ctbk();h.set("editor",{editor:!0,content:n.content,bk:n.bk,title:o||""})}else e.setBookmark200B(),h.set("editor",{content:e.textarea.value,title:o||""})}else h.remove("editor")}else if(N.hasClass("editor-mode")&&q())return"关闭窗口将放弃当前修改，你确定吗？"}var h=t.store=e("./lib/store"),g=e("./SNB.editor.emotion"),v=function(){var e=function(){var e="modernizr";try{return sessionStorage.setItem(e,e),sessionStorage.removeItem(e),!0}catch(t){return!1}}();return e?{set:function(e,t){sessionStorage.setItem(e,JSON.stringify(t))},get:function(e){var t=sessionStorage.getItem(e);return"string"!=typeof t?void 0:JSON.parse(t)}}:{set:$.noop,get:$.noop}}(),b=t.autoresize=e("./lib/autoresize"),y=t.upload=e("./lib/upload"),k=e("./SNB.pdfDialog"),w=window.UE=e("./lib/ueditor"),x=w.dom.domUtils,C=c.prototype,S=$(window),N=$("body"),B=function(){return SNB.scroll.isEditorMode()};window.SNB&&(SNB.editor=t,SNB.store=h);var T={},j=' unselectable="on" contenteditable="false" ';$.browser.webkit?j="":$.browser.mozilla?j='contenteditable="false"':$.browser.msie&&(j=parseInt($.browser.version,10)<9?"":'unselectable="on"'),C.uploadStatusUploading=function(e){var t=this.$root;t&&t.length||(t=this.$uew.closest(".editor"));var o=t.find(".editor-toolbar .upload"),n=t.find(".editor-footer .upload_status");n.html(e||'图片正在上传中，请稍候... <span class="progress"></span>'),o.addClass("uploading"),n.html((e||'上传中 <span class="progress"></span> ')+'<img src="'+SNB.domain["static"]+'/images/loading_020.gif" title=""/>')},C.uploadStatusClear=function(){var e=this.$root;e&&e.length||(e=this.$uew.closest(".editor"));var t=e.find(".editor-toolbar .upload"),o=e.find(".editor-footer .upload_status");t.removeClass("uploading"),o.html("")},C.uploadStatus=function(){var e=this.$root;e&&e.length||(e=this.$uew.closest(".editor"));var t=e.find(".editor-footer .upload_status");return!!t.text()};{var E=t.ctbk=function(e){var t=e.selection.getRange().createBookmark(),o=e.getContent();return{content:o,bk:{id:!0,start:t.start.id,end:t.end&&t.end.id}}};t.setCtbk=function(e,t){e.setContent(t.content),setTimeout(function(){e.selection.getRange().moveToBookmark(t.bk).select()},0)}}C.getSelectionStart=function(){return d(this.textarea)},C.getSelectionEnd=function(){return l(this.textarea)},C.insertString=function(e){if(e){var t=this.textarea,o=this.$textarea,n=o.data("start")||t.selectionStart||0,i=o.data("end")||t.selectionEnd;(void 0===i||n>i)&&(i=n),"function"==typeof e&&(e=e(t.value.substring(n,i)));var a=n+e.length;o.val(t.value.substring(0,n)+e+t.value.substring(i)),"number"==typeof t.selectionStart?(o.get(0).selectionStart=a,o.get(0).selectionEnd=a,o.focus()):(o.data("start",a),o.data("end",a),o.focus(),this.setSelection(a,0))}},C.setSelection=function(e,t){return u(this.textarea,e,t)},C.setSelection200B=function(){var e,t,o=this.textarea.value;-1!=(e=o.indexOf("​"))?-1!=(t=o.indexOf("​",e+1))?t--:t=e:e=t=0,this.reset(o.replace(/\u200B/g,"")),this.setSelection(e,t-e)},C.getContent=function(){return this.editor?this.editor.getContent():SNB.Util.htmlizeContent(this.textarea.value)},C.hasContent=function(){var e=$("<div>"+this.getContent()+"</div>");return $.trim(e.text()).length||e.find("img").length?!0:!1},C.insert=function(e){var t=this.editor?this.editor.execCommand("insertHtml",e):this.insertString(e);return this.options&&this.options.insertFunc&&this.options.insertFunc(C,e),this.editor.focus(),t},C.reset=function(e,t,o){this.editor?(this.editor.setContent(e||x.fillChar),t&&this.editor.selection.getRange().selectNodeContents(this.editor.document.body).shrinkBoundary().collapse(o).select()):(this.textarea.value=e||"",this.$textarea.height(70),t&&(this.$textarea.focus(),this.setSelection(o?0:(e||"").length,0)))},C.setBookmark200B=function(){this.insertString(function(e){return"​"+e+(e&&"​")})},C.ctbk=function(){var e,t,o,n=this.editor,i=this.textarea;return n?E(n):(e=i.value,this.setBookmark200B(),t=i.value,i.value=e,~t.indexOf("​")?(t=t.replace("​",'<span id="_baidu_bookmark_cursor_start_">﻿</span>').replace("​",'<span id="_baidu_bookmark_cursor_end_">﻿</span>'),~t.indexOf('<span id="_baidu_bookmark_cursor_end_">﻿</span>')&&(o="_baidu_bookmark_cursor_end_")):t+='<span id="_baidu_bookmark_cursor_start_">﻿</span>',t=SNB.Util.htmlizeContent(t),{content:t,bk:{id:!0,start:"_baidu_bookmark_cursor_start_",end:o}})},C.insertImage=function(e,t){var o=this;o.editor?r(o.editor,e,t):o.upgrade(function(){r(o.editor,e,t)})};var R=t.init=function(e,o){var n=$(e);n.show();var i=t.textarea($("textarea",n),o||{$emotion:$(".emotion",n),$stock:$(".stock",n),$upload:$(".upload",n)});return i.$root=n,n.data("ta",i),i};t.textarea=function(e,t){var o=e.data("ta");return o||(o=new c(e,t)),o};var O=0,z=t.editor=function(t,o,n,i,a){t=t||70,"function"==typeof i&&(a=i,i={}),w.Editor.prototype.setMinFrameHeight=function(e){var t=S.height();e||(e=t>400?t-177:310),w.browser.gecko&&(e-=1),this.options.minFrameHeight=e,this.fireEvent("contentchange")};{var r=SNB.cssVersion&&SNB.cssVersion["editor.css"];r?"/style/editor-"+r+".css":"/style/editor.css?v="+(new Date).getTime()}i={minFrameHeight:t,pasteplain:!0,autoHeightEnabled:!1===i.autoheight?!1:!0,enterTag:"br",initialStyle:e("./editor_inline.css.js")+i.style,iframeCssUrl:!1},o&&(/\r|\n/.test(o)&&!~o.indexOf("<p>")&&(o=textToHtml(o)),i.initialContent=o);var s=new w.Editor(i);s.UE=w,s.addListener("beforepaste",function(e,t){t.html=t.html.replace(/<(p|li|div|tr|td) [^>]*/gi,function(e,t){return"<"+t}),t.html=SNB.Util.cleanContent(t.html,!1,!1,!0);var o=A(s,t.html,!0);t.html=o.html,o.local&&SNB.Util.failDialog("本地图片请手动上传",200,null,3e3)}),n&&s.render(n),a&&a(s)},A=t.pasteImages=function(e,t,o){console.log("=========== paste images =============");var n=[],i={};return i.html=t.replace(/(<br\s*\/?>)?<img([^>]+)>(<br\s*\/?>)?/gi,function(t,a,r,s){var d=r.match(/src=["']([^"'\s]+)[\s"']/);if(!d)return"";if(d=d[1],$.browser.isMobile||e.ta&&!e.ta.$uew.parent().is(".editor, .editor-wrapper"))return"";var l;if(l=d.match(/(\/images\/vipicon_[0-9].png|\d+-\d{2}x\d{2}\.(gif|jpg))(\?.*)?$/i))return"";if(l=d.match(/\/images\/face\/(\d{2}[^\.]+)\.png(\?.*)?$/i))return SNB.Util.BBCODE_TO_TEXT[l[1]]||t;if(l=d.match(/(http:\/\/xqimg\.imedao\.com\/.+?)(!|%21).*?$/i)||d.match(/(http:\/\/u\.xqimg\.imedao\.com\/.+?)(!|%21).*?$/i))return d=l[1]+"!custom.jpg",(o||a?"<br>​":"")+'<img class="ke_img" src="'+d+'" '+j+" />"+(o||s?"<br>​":"");var u,c,p,f,m="ke_img_paste_"+(++O).toString(10);return d.match(/https?:\/\//i)?((c=r.match(/width=["']?(\d+)/i))&&(c=parseInt(c[1],10),c&&80>c&&(f=!0)),f&&(p=r.match(/height=["']?(\d+)/i))&&(p=parseInt(p[1],10),p&&80>p)?"":(_.each(n,function(e){e[1]==d&&(n.push([m,e[0]]),u=!0)}),u||n.push([m,d]),(o||a?"<br>​":"")+'<img id="'+m+'" class="ke_img_paste" style="max-width: 480px;" src="'+d+'" '+j+" />"+($.browser.msie?"&nbsp;":"")+(o||s?"<br>​":""))):(i.local=!0,"")}),n.length&&(i.upload=!0,D(e,n)),i},D=t.uploadImages=function(e,t){e.uploadImagesCount=e.uploadImagesCount||0;var o,n=e.ta,i={},a=[],r=[];for(_.map(t,function(e){var t={id:e[0]};e[1].indexOf("ke_img_paste_")>-1?i[e[1]]?i[e[1]].push(e[0]):i[e[1]]=[e[0]]:(t.src=e[1],a.push(t))}),_.map(a,function(e){i[e.id]&&(e.same=i[e.id])});(o=a.splice(0,10)).length;)console.log("_imgurls ",o),r.push(p(e,o));return r.length?(n.uploadStatusUploading("正在上传图片，请稍候"),e.uploadImagesCount++,void $.when.apply($,r).done(function(){var t=Array.prototype.slice.call(arguments,0),o=Math.min.apply(Math,t),i=Math.max.apply(Math,t);--e.uploadImagesCount||n.uploadStatusClear(),i&&SNB.Util.failDialog((o>1?"":"部分")+"图片未成功上传，请尝试手动上传。",300,null,3e3)})):!1};C.upgrade=function(e,t){if(this.editor)return!1;"function"==typeof e&&(t=e,e=!1),e||e===!1||(e=this.ctbk());var o=this,n=o.$textarea,a=n.siblings(".ueditor-wrapper"),r="";a.length||(a=$('<div class="ueditor-wrapper" />').insertAfter(n),r+="body,input,label,select,option,textarea,button,fieldset,legend{font:"+n.css("font")+";}"),o.$uew=o.$ueditorWrapper=a,e=e||{},n.attr("readonly",!0),z(e.height||70,x.fillChar,!1,{style:r,autoheight:e.autoheight},function(r){o.editor=r,o.$root.data("editor",r),r.ta=o,n.hide(),a.show(),r.addListener("ready",function(){o.stockKeyup&&r.addListener("keyup",function(e,t){o.stockKeyup(t)}),r.addListener("keyup",i(o)),r.addListener("keyup",_.bind(o.$uew.removeClass,o.$uew,"error")),o.options.ctrlReturn&&r.addListener("keydown",function(e,t){return t.ctrlKey&&13===t.keyCode?(o.options.submitFunc(),setTimeout(function(){$("body>.temp>.at-user-input").trigger("blur").remove()},200),!1):void 0}),r.setContent(e.content||x.fillChar),e.bk&&r.selection.getRange().moveToBookmark(e.bk).select(),r.focus(),t&&t(r)}),r.render(a[0])})},C.fullscreen=function(){var e=this;F(e.$root).then(function(t){S.scrollTop(0),N.addClass("main-editor-mode"),t.setMinFrameHeight(),o(t),S.trigger("scroll").trigger("resize");var n=e.$root.find(".editor-title input.title");!n.val().length&&$.browser.msie&&n.val(n.attr("placeholder")).addClass("placeholder"),setTimeout(function(){t.focus()},0)})};{var I,U,H=t.editorReady=function(e,t){if(o(e),!t.data("ready")){t.data("ready",!0);var n=$(".bold",t),i=$(".underline",t),d=$(".numberlist",t),l=$(".bulletlist",t),u=$(".emotion",t),c=$(".stock",t),p=$(".upload",t),f=t.closest(".editor").find(".ueditor-wrapper");n.on("click",function(){e.execCommand("bold")}),i.on("click",function(){e.execCommand("underline")}),d.on("click",function(){e.execCommand("insertorderedlist","decimal")}),l.on("click",function(){e.execCommand("insertunorderedlist","disc")}),g({editor:e,insert:C.insert},u),c.on("click",a({editor:!0,$uew:f,insert:function(t){e.execCommand("insertHtml",t)}})),s({insertImage:function(t,o){r(e,t,o)},$uew:f,uploadStatusUploading:C.uploadStatusUploading,uploadStatusClear:C.uploadStatusClear,uploadStatus:C.uploadStatus},p),e.addListener("selectionchange",function(){e.queryCommandState("Bold")>0?n.addClass("toolbar-item-active"):n.removeClass("toolbar-item-active"),e.queryCommandState("underline")>0?i.addClass("toolbar-item-active"):i.removeClass("toolbar-item-active"),e.queryCommandState("insertorderedlist")>0?d.addClass("toolbar-item-active"):d.removeClass("toolbar-item-active"),e.queryCommandState("insertunorderedlist")>0?l.addClass("toolbar-item-active"):l.removeClass("toolbar-item-active")})}},F=function(t){if(t.data("fullscreen"))return t.data("fullscreen");var o=$.Deferred();return t.data("fullscreen",o.promise()),t.findOrAppend(">.editor",e("./editor.jade"),{hostDomain:SNB.domain.host},function(e){var n=($("input.title",e),$("input.submit",e),$(".editor-toolbar",e)),r=$(".ueditor-wrapper",e);I=$(".back-container",e),U=$(".submit-container",e);var s=t.data("ta");s?(s.editor?(H(s.editor,n),o.resolve(s.editor),t.addClass("editor-mode")):s.upgrade(function(e){H(e,n),o.resolve(e),t.addClass("editor-mode"),e.setMinFrameHeight()}),r.data("ta",s)):z(window.innerHeight>350?window.innerHeight-260:90,"",!1,function(e){s={editor:e,$uew:r,uploadStatusUploading:C.uploadStatusUploading,uploadStatusClear:C.uploadStatusClear,uploadStatus:C.uploadStatus,insert:function(t){e.execCommand("insertHtml",t)}},s.reset=$.proxy(C.reset,s),e.ta=s,e.addListener("ready",function(){var t=a(s);e.addListener("keyup",function(e,o){t(o)}),e.addListener("keyup",i(s)),H(e,n),o.resolve(e)}),t.addClass("editor-mode"),t.data("editor",e),r.data("ta",s),e.render(r[0])}),r.find(">iframe").prop("tabindex","2"),$(".submit-container input[type=button]",e).prop("tabindex","3")}),t.data("fullscreen")},q=(t.fullscreen=function(e,t,n,i,a){F(N).then(function(r){N.addClass("editor-mode"),o(r),S.trigger("resize"),i&&i.$back&&i.$back.length&&function(){I.empty().each(function(e,t){i.$back.clone(!0).appendTo(t)})}(),i&&i.$submit&&i.$submit.length&&function(){U.empty().each(function(e,t){i.$submit.clone(!0).appendTo(t)}),$("input[type=button]",U).prop("tabindex","3")}();var s=$("body>.editor .editor-toolbar .toolbar-item.upload");i&&"boolean"==typeof i.uploadImage&&i.uploadImage===!1?s.hide():s.show(),r.setContent(e),N.data("editorInitialContent",r.getContent());var d=r.selection.getRange();n?d.moveToBookmark(n):d.collapse(!0),d.select(!0),a&&a(r),t="string"==typeof t?t:"";var l=$("body>.editor .editor-title input.title");l.val(t),!t&&$.browser.msie&&l.val(l.attr("placeholder")).addClass("placeholder")})},function(){return N.data("editor").getContent()!=N.data("editorInitialContent")});t.main=function(t,o,n,i,a,r){o=o||{},o.content=SNB.Util.cleanContent(o.content||"",!0),$(t).findOrAppend(">.editor",e("./editor.jade"),{hostDomain:SNB.domain.host},function(s){var d=$("input.title",s),l=($(".ueditor-wrapper",s),$(".editor-toolbar",s),$(".editor-footer",s)),u=$.browser.isMobile;a=a&&!u,i=i&&$.browser.supportUpload,s.show(),l.html(e("./editor-footer.jade")({hostDomain:SNB.domain.host}));var c=$("input.main-submit",l);$(".ueditor-wrapper").hide().after('<textarea id="status-box"></textarea>');var p={$emotion:$(".emotion",l),$stock:$(".stock",l),$upload:$(".upload",l),$pdf:$(".pdf",l),ctrlReturn:!0,submitFunc:n,autoResize:70};i||(p.$upload.remove(),delete p.$upload),r||(p.$pdf.remove(),delete p.$pdf);var f=R(t,p);o.editor?f.upgrade(o):o.content?(f.reset(o.content),f.setSelection200B(),f.upgrade()):(f.$textarea.addClass("not-init"),f.$textarea.one("mouseup",function(){f.$textarea.removeClass("not-init"),u||f.upgrade()})),o.title&&d.val(o.title),a?($(".fullscreen",l).click(function(){f.$textarea.trigger("focus"),f.fullscreen()}),$(".back-container",s).each(function(e,t){$('<a href="javascript:;" class="back">返回</a>').on("click",function(e){N.removeClass("main-editor-mode"),S.off("resize.fullEditor"),f.editor.setMinFrameHeight(70),setTimeout(function(){f.editor.focus()},0),e.preventDefault()}).appendTo(t)})):$(".fullscreen",l).remove(),c.on("click",n)})}}N.data("editChanged",q),$.browser.msie&&parseFloat($.browser.version)<9?$(window.top).on("beforeunload",m):S.on("beforeunload",m),N.on("click",".ui-widget-overlay",function(e){var t=$(e.target),o=$("#stockbox, #at-suggestion",t.prev());o.length&&o.dialog("close")})}),define("editor_inline.css.js",[],function(e,t,o){o.exports="a,abbr,acronym,address,applet,b,big,blockquote,body,caption,center,cite,code,dd,del,dfn,div,dl,dt,em,fieldset,font,form,h1,h2,h3,h4,h5,h6,html,i,iframe,img,ins,kbd,label,legend,object,ol,p,pre,q,s,samp,small,span,strike,strong,sub,sup,table,tbody,td,tfoot,th,thead,tr,tt,u,ul,var{margin:0;border:0;padding:0;outline:0}body{color:#000;padding:0;word-wrap:break-word}body,button,fieldset,input,label,legend,option,select,textarea{font:14px/1.5 'Helvetica Neue',Helvetica,Arial,sans-serif}ol,ul{padding-left:3em}ul li{list-style:disc}ol li{list-style:decimal}.ke_img{background:#f9f9f9}a{color:#000!important;text-decoration:none!important}"}),define("editor.jade.js",function(require,exports,module){function anonymous(locals,attrs,escape,rethrow,merge){attrs=attrs||jade.attrs,escape=escape||jade.escape,rethrow=rethrow||jade.rethrow,merge=merge||jade.merge;var buf=[];with(locals||{}){buf.push('<div class="editor"><div class="editor-toolbar-wrapper"><div class="editor-toolbar fixed"><span title="加粗" class="toolbar-item bold"></span><span title="下划线" class="toolbar-item underline"></span><span title="有序列表" class="toolbar-item numberlist"></span><span title="无序列表" class="toolbar-item bulletlist"></span><div class="toolbar-line"></div><span title="插入表情" class="toolbar-item emotion"></span><span title="插入股票" class="toolbar-item stock"></span><span title="插入图片" class="toolbar-item upload"><form'),buf.push(attrs({action:""+hostDomain+"/service/upload_photo",method:"post",enctype:"multipart/form-data"},{action:!0,method:!0,enctype:!0})),buf.push('><input name="file" type="file"/></form></span><span class="upload_status"></span><div class="back-container"></div></div></div><div class="editor-title"><input name="title" tabindex="1" type="text" placeholder="点击这里输入标题" class="title"/></div><div class="editor-wrapper"><div class="ueditor-wrapper"></div></div><div class="editor-footer"><div class="submit-container"><input type="button" value="发布" class="submit main-submit disabled"/></div><div class="back-container"></div><div class="footer-controller"></div></div></div>')}return buf.join("")}module.exports=anonymous}),define("editor-footer.jade.js",function(require,exports,module){function anonymous(locals,attrs,escape,rethrow,merge){attrs=attrs||jade.attrs,escape=escape||jade.escape,rethrow=rethrow||jade.rethrow,merge=merge||jade.merge;var buf=[];with(locals||{}){buf.push('<div class="back-container"></div><div class="footer-controller"><span title="插入表情" class="emotion"><s></s><span>表情</span></span><span title="插入股票代码" class="stock"><s></s><span>股票</span></span><span title="上传图片" class="upload"><s></s><span>图片</span></span>');var showPdf=function(){return("undefined"==typeof req_isMobile||req_isMobile||"undefined"==typeof req_isPad||req_isPad)&&("undefined"==typeof $||!$.browser||$.browser.isMobile||$.browser.isPad)?!1:!0}();showPdf&&buf.push('<span title="上传研报 pdf 文件" class="pdf"><s></s><span>PDF</span></span>'),buf.push('<span title="添加标题，给文章排版" class="fullscreen"><s></s><span>长文</span></span><span class="upload_status"></span></div><div class="submit-container"><input type="button" value="发布" class="main-submit disabled"/></div>')}return buf.join("")}module.exports=anonymous});