define("SNB.status.js",["widget/donate","widget/profile_pin","widget/global_pin"],function(t){function e(t){var e=t.user,i=e.profile_image_url?e.profile_image_url.split(","):"";return e.img=SNB.domain.photo+"/"+(i.length>3?i[3]:1==i.length?i[0]:"community/default/avatar.png!30x30.png"),t.createdAt=t.timeBefore,t.count=t.reply_count,t}function i(t,i){if(this.app="undefined"==typeof i||"object"==typeof i&&"undefined"==typeof i.app?"desktop":i.app,"undefined"==typeof t.get("notLazy")){switch(this.app){case"desktop":if(!t.id&&i.el){var a=s(i.el),n={id:a.find(".headpic a").data("id"),profile:a.find(".headpic a").attr("href"),img:a.find(".headpic a img").attr("src"),screen_name:a.find(".headpic a").data("name")},o=a.find(".headpic a").data("verified");o&&"null"!=o&&(n.verified=!0,n.verified_description=o);var r,d=a.find(".status > .retweet");if(d.length){var l=d.find("p.title a"),c={id:l.data("id"),profile:l.attr("href"),screen_name:l.data("name")};r={title:d.find(".title").next("h4").text(),id:d.find(".meta .time").attr("href").split("/").pop(),pdf:d.find("img.show-retweet").data("pdf"),target:d.find(".meta .time").attr("href"),user:c}}var p="",u="",m=a.find(".status div.detail").clone();m.find(".fold-all, .show-all").remove(),p=m.html();var u="",f=a.find(".status > div.summary");if(f.length){var h=f.clone();h.find(".fold-all, .show-all").remove(),u=h.html()}else u=p;return t.set({user:n,retweeted_status:r,retweet_status_id:r&&r.id,id:parseInt(a.attr("id").split("_")[1],10),text:p,canEdit:n.id==SNB.currentUser.id,source:a.find(".infos span").text().replace("来自",""),title:a.find(".status > h4 a").text(),target:a.find(".infos .time").attr("href"),favorited:"收藏"!=a.find(".ops > .addFav").text(),pdf:a.find("img.show-all").data("pdf"),notLazy:!1,description:u}),t}s.browser.isPad||s.browser.isMobile||this.set(SNB.Util.statusPdf({text:t.get("text"),description:t.get("description"),retweeted_status:t.get("retweeted_status")}));var r,n=this.get("user"),g=(n.profile_image_url?n.profile_image_url.split(","):"",SNB.Status.cleanUser(n,{img_size:"50"})),_=SNB.Util.parseTime(this.get("created_at"));(r=this.get("retweeted_status"))&&(s.browser.isPad||s.browser.isMobile||SNB.Util.statusPdf(r),r.re_description=SNB.helpers.parseLongUrl(r.description),r.re_reply_count=r.reply_count,r.re_title=r.title,r.re_createdAt=SNB.Util.parseTime(r.created_at),r.text=SNB.Image.lazyload(SNB.Util.parseContent(r.pdf?r.pdfRemovedContent:r.text)),r.text=SNB.helpers.parseLongUrl(r.text),r.user||(r.re_reply_count=0));var p=SNB.Image.lazyload(this.get(this.get("pdf")&&!this.get("retweeted_status")?"pdfRemovedContent":"text")),v=this.get("favorited");(!v||v&&SNB.currentUser.id!==SNB.profileUser.id)&&(this.unset("favorited"),this.unset("favorited_created_at"));var S=this.get("comment");S&&(S=e(S),this.set({comment:S})),this.unset("user_id"),this.set({retweeted_status:r}),this.set({user:g,createdAt:_,text:SNB.helpers.parseLongUrl(SNB.Util.parseContent(p)),description:SNB.helpers.parseLongUrl(this.get("description")),notLazy:!0,retweeted_status:r});break;case"tablet":var n=this.get("user"),g=(n.profile_image_url?n.profile_image_url.split(","):"",SNB.Status.cleanUser(n,{img_size:"50"})),_=SNB.Util.parseTime(this.get("created_at")),w=this.get("firstImg");w=w&&w.replace("!thumb.jpg","!iphone2.jpg")||"";var r;(r=this.get("retweeted_status"))&&(r.re_description=r.description,r.re_reply_count=r.reply_count,r.re_title=r.title,r.firstImg=r.firstImg&&r.firstImg.replace("!thumb.jpg","!iphone2.jpg")||"",r.re_createdAt=SNB.Util.parseTime(r.created_at),r.text=SNB.Image.lazyload(SNB.Util.parseContent(r.pdf?r.pdfRemovedContent:r.text),!1,!0),r.user||(r.re_reply_count=0));var p=SNB.Image.lazyload(this.get(this.get("pdf")&&!this.get("retweeted_status")?"pdfRemovedContent":"text")),v=this.get("favorited");(!v||v&&SNB.currentUser.id!==SNB.profileUser.id)&&(this.unset("favorited"),this.unset("favorited_created_at"));var S=this.get("comment");S&&(S=e(S),this.set({comment:S})),this.unset("user_id"),this.set({retweeted_status:r}),this.set({user:g,firstImg:w,createdAt:_,text:SNB.Util.parseContent(p,!1,!0),description:this.get("description"),notLazy:!0,retweeted_status:r})}return this}}function a(t){return t="string"==typeof t?s.parseJSON(t):t,t.user?(t.user=SNB.Status.cleanUser(t.user,{img_size:"30"}),t.createdAt=SNB.Util.parseTime(t.created_at),t.text=SNB.Util.cleanContent(t.text),t):void 0}var s=jQuery,n=t("widget/donate"),o=t("widget/profile_pin"),r=t("widget/global_pin");SNB.Models.Status=Backbone.Model.extend({initialize:function(t,e){this.app="undefined"==typeof e||"object"==typeof e&&"undefined"==typeof e.app?"desktop":e.app},fav:function(t){var e=this;this.get("favorited")?SNB.get("/favorites/destroy/"+this.id+".json",function(){e.set({favorited:!1},{silent:!0}),t&&t()}):SNB.get("/favorites/create.json",{id:this.id},function(){e.set({favorited:!0},{silent:!0}),t&&t()})}}),SNB.Collections.Statuses=Backbone.Collection.extend({initialize:function(t,e){this.app="undefined"==typeof e||"object"==typeof e&&"undefined"==typeof e.app?"desktop":e.app},model:SNB.Models.Status,sync:function(t,e,i){return i.url=-1!==i.url.indexOf("http")?i.url:SNB.domain.base+i.url,i.dataType="jsonp",i.data=i.data||{},i.data.access_token=SNB.Util.getAccessToken(),s.ajax(i)},fetch:function(t){switch(this.app){case"desktop":t||(t={});var e=this,i=t.success;return t.success=function(a,s,n){t.show&&e.more(e.parse(a,n),t),i&&i(e,a)},this.sync.call(this,"read",this,t);case"tablet":t||(t={});var e=this,i=t.success,a=t.params&&t.params.key,n=t.params&&t.params.addStorage,o=t.params&&t.params.older,r=localStorage;return t.success=function(d,l,c){d="object"==typeof d&&(d.hasOwnProperty("statuses")||d.hasOwnProperty("list"))?d.statuses||d.list:d;var p=(JSON.parse(JSON.stringify(d)),JSON.parse(r.getItem(a))),u=d&&d.length,m=p&&p.length,f=t.count;if(n){u>=f?r.setItem(a,JSON.stringify(d)):f>=u+m?(p=d.concat(p),r.setItem(a,JSON.stringify(p))):(p=p.slice(0,f-u),p=d.concat(p),r.setItem(a,JSON.stringify(p)));var h=(new Date).getTime();r.setItem(a+":timestamp",h)}if(d.length>=t.count&&!o){{s(t.el).height()}s(t.el).html("");var g=new SNB.Collections.Statuses(d,{app:"tablet"}),_=new SNB.Views.StatusList({el:t.el,app:"tablet",drag_support:!0,timeLine_type:"home",url:"/statuses/home_timeline.json",collection:g,key:a});return void _.render()}t.show&&e.more(e.parse(d,c),t),i&&i(e,d)},this.sync.call(this,"read",this,t)}},more:function(t){var e=this,i=_.pluck(e.models,"id");e.add(t);var a=_.pluck(t,"id"),s=[];_.each(a,function(t){-1===_.indexOf(i,t)&&s.push(e.get(t))}),e.trigger("addStatuses",s)},parse:function(t){return"object"!=typeof t&&(t=s.parseJSON(t)),t}}),SNB.Templates.Remark='<span class="user_remark" data-name="{{=it.user.screen_name}}" style="{{=it.user.remark ? "display:inline" : "display:none" }}">({{=it.user.remark}})</span>',SNB.Templates.UserTitle="{{ if (!it.hideUser){ }}<p class='userTitle'><a target='_blank' href='{{=it.user.profile}}' data-name='{{=it.user.screen_name}}'><span>{{=it.user.screen_name}}</span>{{#def.Remark}}{{#def.verified}}</a>{{ if(it.app_type === 'tablet'){ }}<span class='createdAtTime' date='{{=it.created_at}}' data-target='{{=it.target}}'>{{=it.createdAt}}</span>{{ } }}:</p>{{ } }}",SNB.Templates.Verified="{{ if (it.user.verified){ }}<img width='16px' height='16px' class='vipicon' title='{{=it.user.verified_description}}' src='"+SNB.domain["static"]+"/images/vipicon_{{=it.user.verified_type||1}}{{= it.app_type === 'tablet' ? '@2x' : ''}}.png'/>{{ } }}",SNB.Templates.RTVerified="{{ if (it.retweeted_status.user.verified){ }}<img width='16px' height='16px' class='vipicon'  title='{{=it.retweeted_status.user.verified_description}}' src='"+SNB.domain["static"]+"/images/vipicon_{{=it.retweeted_status.user.verified_type || 1}}{{= it.app_type === 'tablet' ? '@2x' : ''}}.png'/>{{ } }}",SNB.Templates.RTRemark='<span class="user_remark" data-name="{{=it.retweeted_status.user.screen_name}}" style="{{=it.retweeted_status.user.remark ? "display:inline" : "display:none" }}">({{=it.retweeted_status.user.remark}})</span>',SNB.Templates.RTUserTitle="{{ if (it.retweeted_status.user){ }}<p class='userTitle'><a target='_blank' href='{{=it.retweeted_status.user.profile}}' data-id='{{=it.retweeted_status.user.id}}' data-name='{{=it.retweeted_status.user.screen_name}}'><span>{{=it.retweeted_status.user.screen_name}}</span>{{#def.RTRemark}}{{#def.RTVerified}}: </a></p>{{ } else{ }}<p><a>用户已被删除</a>: </p>{{ } }}",SNB.Templates.StatusContentDot="<div class='status{{= (it.app_type!=='tablet') && (it.expend || it.pdf)?' expandable':''}}'>{{ if(it.status_type !== 'topic') { }}{{#def.userTitle}}{{ if (it.title){ }}<h4><a href='{{=it.target}}' target='_blank'>{{=it.title}}</a></h4>{{ } }}{{ }else{ }}{{ if (it.topic_title){ }}<span class='createdAtTime' date='{{=it.created_at}}' data-target='{{=it.target}}'>{{=it.timeBefore}}</span><h3><a href='{{=it.target}}' target='_blank'>{{=it.topic_title}}</a></h3>{{ } }}<p class='info_block'>{{ if(!it.authorIsStock){ }}<span class='author'>作者：<a href='{{=it.user.profile}}' data-name='{{=it.user.screen_name}}' data-id='{{=it.user.id}}' data-verified='{{=it.user.verified_description}}' class='screen_name'><span>{{=it.user.screen_name}}</span>{{ if(it.user.verified){ }}<img width='16px'  class='vipicon' height='16px' title='{{=it.user.verified_description}}' src='"+SNB.domain["static"]+"/images/vipicon_{{=it.user.verified_type || 1}}{{= it.app_type === 'tablet' ? '@2x' : ''}}.png'/>{{ } }}</a></span>{{ } }}{{ if(it.topic_symbol){ }}<span class='stocks'>股票：{{=it.topic_symbol}}</span>{{ } }}</p>{{ } }}{{ if(it.app_type!=='tablet') { }}{{ if (it.expend || it.pdf){ }}{{ if (it.blocking) { }}<div class=\"summary block-tip\">{{= it.topic_desc || it.description ? (it.topic_desc || it.description) : \"\" }}</div>{{ } else { }}<div class='summary'>{{=it.topic_desc||it.description?(it.topic_desc||it.description+\"<span class='show-all'><i></i>展开</span>\"):''}}</div>{{ } }}{{ } }}{{ } else { }}<div class='summary'>{{=it.topic_desc||it.description?(it.topic_desc||it.description):''}}</div>{{ } }}{{ if(it.app_type!=='tablet') { }}<div class='detail'>{{ if (it.blocking) { }}<span class=\"block-tip\">{{= it.text }}</span>{{ } else { }}{{=(it.pdf && !it.retweeted_status ? it.pdfRemovedContent : it.text)}}{{ } }}{{ if (it.expend || it.pdf){ }}<span class='fold-all'><i></i>收起</span>{{ } }}</div>{{ } }}{{ if (it.retweeted_status){ }}<div class='retweet{{= (it.app_type!=='tablet') && (it.retweeted_status.expend || it.retweeted_status.pdf)?' expandable':''}}'>{{#def.RTUserTitle}}{{= (it.retweeted_status.re_title)?'<h4><a href=\"' + it.retweeted_status.target + '\" target=\"_blank\">' + it.retweeted_status.re_title + '</a></h4>':''}}{{ if (it.app_type!=='tablet') { }}{{ if (it.retweeted_status.blocking) { }}<div class=\"block-tip\">{{= (it.retweeted_status.expend || it.retweeted_status.pdf) ? (\"<div class=re-summary>\" + (it.retweeted_status.re_description || \"\") + \"</div>\") : \"\" }}</div>{{ } else { }}{{= (it.retweeted_status.expend || it.retweeted_status.pdf)?'<div class=\"re-summary\">' + (it.retweeted_status.re_description?(it.retweeted_status.re_description + '<span class=\"show-retweet\"><i></i>展开</span>'):'')+'</div>':''}}{{ } }}{{ } else { }}{{= '<div class=\"re-summary\">' + (it.retweeted_status.re_description?(it.retweeted_status.re_description ):'')+'</div>'}}{{ } }}{{ if(it.app_type!=='tablet') { }}<div class='re-detail'>{{=it.retweeted_status.text}}{{ if (it.retweeted_status.expend || it.retweeted_status.pdf){ }}<span class='fold-retweet'><i></i>收起</span>{{ } }}</div>{{ } }}{{ if (it.retweeted_status.pdf){ }}<img src='http://assets.imedao.com/images/pdf.png' class='show-retweet re-summary'/>{{ } else if (it.retweeted_status.firstImg){ }}{{ if (it.app_type!=='tablet'){ }}<img src='{{=it.retweeted_status.firstImg}}' class='show-retweet re-summary'/>{{ } else { }}<img src='{{=it.retweeted_status.firstImg}}' style='width:80px;height:80px' class='show-retweet re-summary'/>{{ } }}{{ } }}<div class='meta'>{{ if(it.app_type!=='tablet') { }}<a target='_blank' class='time' date='{{=it.retweeted_status.created_at}}' href='{{=it.retweeted_status.target}}'>{{=it.retweeted_status.re_createdAt}}</a>{{ if (it.retweeted_status.re_reply_count){ }}<a target='_blank' class='target' href='{{=it.retweeted_status.target}}'>相关讨论({{=it.retweeted_status.re_reply_count}})</a>{{ } }}{{ } else { }}<span class='infos'><span>相关讨论({{=it.retweeted_status.re_reply_count}})</span></span>{{ } }}</div></div>{{ } }}{{ if (it.pdf){ }}<img src='http://assets.imedao.com/images/pdf.png' class='show-all summary'/>{{ } else if (it.firstImg){ }}{{ if (it.app_type!=='tablet'){ }}<img src='{{=it.firstImg}}' class='show-all summary'/>{{ } else { }}<img src='{{=it.firstImg}}' style='width:80px;height:80px' class='show-all summary'/>{{ } }}{{ } }}</div>",SNB.Templates.StatusDot='{{ if (it.user.id == {{#def.uid}}) { }}<div class="btn-operation"><a class="btn-sub-menu" href="#">管理</a><ul class="set-sub-menu"><li><a href="#" class="global-pin" data-id="{{= it.id }}">粉丝头条</a>{{ if (it.mark == 1) { }}<li><a href="#" class="btn-cancel-profile-pin" data-id="{{= it.id }}">取消置顶</a>{{ } else { }}<li><a href="#" class="profile-pin" data-id="{{= it.id }}">主页置顶</a>{{ } }}{{ if (it.canEdit) { }}<li><a href="#" class="edit" data-id="{{= it.id }}">修改</a>{{ } }}<li><a href="#" class="delete" data-id="{{= it.id }}">删除</a></ul></div>{{ } }}{{# def.head}}<div class=\'content\'>{{#def.status}}<div class=\'meta\'><div class=\'infos\'>{{ if(it.app_type!==\'tablet\') { }}'+"<a class='time' date='{{=it.created_at}}' href='{{=it.target}}'>{{=it.createdAt}}</a><span>来自{{ if (it.source_link) {}}<a class='source' href='{{=it.source_link}}' target='_blank'>{{=it.source}}</a>{{ } else { }}{{=it.source}}{{ } }}</span>{{ }else{ }}<span>{{ if(it.tablet_profile_status){ }}<a class='time' date='{{=it.created_at}}' href='{{=it.target}}'>{{=it.createdAt}}</a>{{ } }}来自{{=it.source}}</span>{{ } }}{{ if (it.mark == 1) { }}<span class=\"status-marker status-pin\">置顶</span>{{ } else if (it.mark == 2) { }}<span class=\"status-marker status-promo\">推广</span>{{ } else if (it.mark == 3) { }}<span class=\"status-marker status-hot\">热门</span>{{ } }}{{ if(it.app_type !== 'tablet') { }}{{ if (it.user.id !== {{#def.uid}}) { }}<a href='#' class='reportSpam' data-id='{{=it.id}}'>举报</a>{{ } }}{{ } }}</div><div class='ops'>{{ if(it.app_type!=='tablet') { }}{{ if (it.user.id == SNB.currentUser.id && it.view_count) { }}<span class=\"view-count\">阅读({{= it.view_count}})</span>{{ } }}<a href='#' class='repost {{=it.user.id !== {{#def.uid}}? 'second':'' }}' data-id='{{=it.id}}'>转发{{=it.retweet_count? ('(' + it.retweet_count + ')'): ''}}</a><a href='#' class='addFav' data-id='{{=it.id}}'>收藏</a>{{ if (it.user.id != SNB.currentUser.id) { }}<a class=\"donate\" href=\"#\" data-id=\"{{=it.id}}\">{{ } else { }}<a class=\"donate self\" href=\"#\" data-id=\"{{=it.id}}\">{{ } }}赞助{{ if (it.donate_snowcoin) { }}<span class=\"number\">(<em class=\"snow-coin\" data-count=\"{{= it.donate_snowcoin }}\">{{#def.coin}}</em>)</span>{{ } else { }}<span class=\"number\" style=\"display:none;\">(<em class=\"snow-coin\" data-count=\"0\">0</em>)</span>{{ } }}</a><a href='#' class='statusComment last'  data-id='{{=it.id}}'>评论{{=it.reply_count? ('(' + it.reply_count + ')'):''}}</a>{{ } else { }}<span>转发{{=it.retweet_count? ('(' + it.retweet_count + ')'): '(0)'}}</span><span>评论{{=it.reply_count? ('(' + it.reply_count + ')'): '(0)'}}</span>{{ } }}</div></div></div>{{ if(it.app_type!=='tablet') { }}<div class='commentContainer'></div>{{ } }}</div>",SNB.Templates.StatusHeadDot="{{ if (!it.hideUser){ }}<div class='headpic'>{{ if(it.status_type === \"topic\"){ }}<a target='_blank' class='noToolTip' href='{{=it.target}}' data-name='{{=it.user.screen_name}}' data-id='{{=it.user.id}}' data-verified='{{=it.user.verified_description}}'>{{ if(it.app_type!=='tablet') { }}<img width=\"200px\" class=\"lazy\" height=\"150px\" src=\"http://assets.imedao.com/images/image_default.png\" data-original=\"{{=it.topic_pic}}\"/>{{ }else{ }}<img width=\"200px\" class=\"lazy\" height=\"150px\" src=\"http://assets.imedao.com/images/image_default@2x.png\" data-original=\"{{=it.topic_pic}}\"/>{{ } }}</a>{{ }else{ }}{{ if(it.app_type!=='tablet') { }}<a target='_blank' href='{{=it.user.profile}}' data-name='{{=it.user.screen_name}}' data-id='{{=it.user.id}}' data-verified='{{=it.user.verified_description}}'><img width='50px' height='50px' src='{{=it.user.img}}'/></a>{{ }else{ }}<a target='_blank' href='{{=it.user.profile}}' data-name='{{=it.user.screen_name}}' data-id='{{=it.user.id}}' data-verified='{{=it.user.verified_description}}'><img width='50px' height='50px' src='{{=it.user.img_100}}'/></a>{{ } }}{{ } }}</div>{{ } }}",SNB.Templates.statusFunc=doT.template(SNB.Templates.StatusDot,void 0,{userTitle:SNB.Templates.UserTitle,verified:SNB.Templates.Verified,Remark:SNB.Templates.Remark,RTRemark:SNB.Templates.RTRemark,RTVerified:SNB.Templates.RTVerified,uid:SNB.currentUser&&SNB.currentUser.id||0,RTUserTitle:SNB.Templates.RTUserTitle,status:SNB.Templates.StatusContentDot,head:SNB.Templates.StatusHeadDot}),SNB.Views.Status=Backbone.View.extend({model:SNB.Models.Status,tagName:"li",events:{},initialize:function(t){this.app="object"==typeof t&&"undefined"==typeof t.app?"desktop":t.app;var e=this.model,a=s.proxy(i,e);e=a(e,t),this.model.bind("change",this.render,this),this.model.bind("destroy",this.remove,this)},render:function(){switch(this.app){case"desktop":if(this.model.toJSON().blocked)return{};if(this.model.toJSON().id){var t=this.model.toJSON().donate_snowcoin;t>9999&&(t=t%1e4>99?(t/1e4).toFixed(2)+"万":Math.floor(t/1e4)+"万"),SNB.Templates.statusFunc=doT.template(SNB.Templates.StatusDot,void 0,{userTitle:SNB.Templates.UserTitle,verified:SNB.Templates.Verified,Remark:SNB.Templates.Remark,RTRemark:SNB.Templates.RTRemark,RTVerified:SNB.Templates.RTVerified,uid:SNB.currentUser&&SNB.currentUser.id||0,RTUserTitle:SNB.Templates.RTUserTitle,status:SNB.Templates.StatusContentDot,head:SNB.Templates.StatusHeadDot,coin:t});var e=SNB.Templates.statusFunc(this.model.toJSON());s(this.el).html(e);var i=this;if(SNB.Status.expandStatus(this.el,this.model),"favs"===SNB.data.type&&i.model.get("favorited_created_at")){var a=SNB.Util.parseTime(i.model.get("favorited_created_at"));s(i.el).find(".headpic").before("<p class='favAt'>收藏于："+a+"</p>"),SNB.profileUser.isGuest||SNB.currentUser.id!==SNB.profileUser.id||s(i.el).find(".addFav").text("取消收藏").attr("canRemove",1)}}return this;case"tablet":var i=this;if(this.model.toJSON().blocked)return{};if(this.model.toJSON().id){this.model.set({app_type:"tablet",expend:!0}),t>9999&&(t=t%1e4>99?(t/1e4).toFixed(2)+"万":Math.floor(t/1e4)+"万"),SNB.Templates.statusFunc=doT.template(SNB.Templates.StatusDot,void 0,{userTitle:SNB.Templates.UserTitle,verified:SNB.Templates.Verified,Remark:SNB.Templates.Remark,RTRemark:SNB.Templates.RTRemark,RTVerified:SNB.Templates.RTVerified,uid:SNB.currentUser&&SNB.currentUser.id||0,RTUserTitle:SNB.Templates.RTUserTitle,status:SNB.Templates.StatusContentDot,head:SNB.Templates.StatusHeadDot,coin:t});var e=SNB.Templates.statusFunc(this.model.toJSON());s(this.el).html(e)}return this}},remove:function(){switch(this.app){case"desktop":s(this.el).remove();break;case"tablet":}}}),SNB.Views.StatusList=Backbone.View.extend({initialize:function(t){var e=this;switch("undefined"==typeof t||"object"==typeof t&&"undefined"==typeof t.app?(t.app="desktop",e.app="desktop"):e.app=t.app,t.app){case"desktop":t.bootstrap&&(SNB.log("initialize from rendered html"),s(t.el).find(".status-list >li").each(function(a,n){var o=new SNB.Models.Status(null,{el:n}),r=s.proxy(i,o);if(t.el=n,o=r(o,t),o.mark=s(n).data("mark"),e.collection.add(o),SNB.Status.expandStatus(n,o),SNB.currentUser.isGuest||SNB.currentUser.id!=o.get("user").id)s(n).find(".infos").append("<a href='#' class='reportSpam' data-id='"+o.id+"'>举报</a>");else{new SNB.Views.Status({model:o,el:n})}}),setInterval(function(){e.refreshTime()},3e4));break;case"tablet":this.drag_support=t.drag_support,this.key=t.key,this.el=t.el,this.timeLine_type=t.timeLine_type,this.status_type=t.status_type||{},this.url=t.url,this.data=t.data,this.data_extend=t.data_extend,SNB.Status.attachEvent({$el:s(this.el),app_type:"tablet",collection:this.collection})}this.collection.bind("addStatuses",this.addStatuses,this),this.collection.bind("remove",this.remove,this)},events:{"click .statusComment":"comment","click .reportSpam":"reportSpam","click .repost":"retweet","click .addFav":"fav","click .delete":"delete","click .share":"share","click .edit":"edit","update .ops":"updateStatus","click .donate":"donate","click .source":"statistic","click .btn-sub-menu":"showSubMenu","click .global-pin":"globalPin","click .profile-pin":"profilePin","click .btn-cancel-profile-pin":"cancelProfilePin"},statistic:function(t){var e=s(t.target).text();"中信证券"===e&&window._hmt&&_hmt.push(["_trackEvent","zxzq","click",e]),"长城证券"===e&&window._hmt&&_hmt.push(["_trackEvent","cczq","click",e])},donate:function(t){function e(t){var e=i.find(".number"),a=i.find(".snow-coin"),s=a.data("count")-0;e.show(),s+=t-0,a.data("count",s),s>9999&&(s=s%1e4>99?(s/1e4).toFixed(2)+"万":Math.floor(s/1e4)+"万"),a.text(s)}t.preventDefault();var i=s(t.target).is(".donate")?s(t.target):s(t.target).parents(".donate");if(clearTimeout(i.data("timeout")),i.is(".self"))return!1;var a=i.attr("data-id"),o=this.collection.get(a),r=o.toJSON()||{},d={id:a,type:"status",user:r.user,uri:SNB.domain.host+r.target.replace(SNB.domain.host,""),status:r};SNB.Util.checkLogin(function(){n(d,function(t){e(t)})})},showSubMenu:function(t){t.preventDefault();var e=s(t.target),i=e.siblings(".set-sub-menu");return i.show(),!1},globalPin:function(t){t.preventDefault(),s(".set-sub-menu").hide();var e=s(t.target),i={id:e.attr("data-id")};return SNB.Util.checkLogin(function(){r(i)}),!1},profilePin:function(t){t.preventDefault(),s(".set-sub-menu").hide();var e=s(t.target),i=e.attr("data-id"),a={id:i,status:this.collection.get(i).toJSON()};return SNB.Util.checkLogin(function(){o(a)}),!1},cancelProfilePin:function(t){t.preventDefault(),s(".set-sub-menu").hide();var e=s(t.target),i={id:e.attr("data-id")};return SNB.Util.checkLogin(function(){SNB.Util.confirmDialog("确定取消主页置顶吗？",function(){s.get("/c/pin/session",function(t){var a=t[1].toString();s.post("/valueadded/top/cancel.json",{top_type:1,session_token:a},function(t){t&&t.success&&(SNB.Util.stateDialog("已经取消主页置顶"),s("#status_"+i.id).find(".status-marker").remove(),e.removeClass("btn-cancel-profile-pin").addClass("profile-pin").text("主页置顶"))})})}).dialog({modal:!0,width:300,minHeight:50})}),!1},updateStatus:function(t,e){var i=this;i.update({url:"/statuses/home_timeline.json",older:!1,count:10,el:s(i.el),params:{addStorage:!0,key:i.key},success:function(){i.collection.more(SNB.data.newStatuses),e&&e(SNB.data.newStatuses.length),SNB.data.newStatuses=[],SNB.Util.callBrick({homeTimelineUpdated:1})},fail:function(){}})},comment:function(t){switch(this.app){case"desktop":t.preventDefault();var e=t.target,i=this.collection.get(s(e).attr("data-id")),a=i.toJSON()||{},n=a.user,o=a.retweeted_status,r=s(e).data("commentsView");if(r)r.toggle();else{var d=s(e).text(),l=s(e).closest("li#status_"+a.id),c=l.find(".commentContainer");/\d+/gi.test(d)&&c.addClass("display_textarea"),c.siblings(".searchComment").hide(),c.show();var p=function(){SNB.data.status_user_id=n.id,SNB.data.retweeted_status_user_id=o&&o.user.id;var i=new SNB.Collections.Comments([],{statusId:a.id,commentLink:t.target,commentContainer:c}),r=new SNB.Views.Comments({el:c,collection:i,statusId:s(e).attr("data-id"),commentLink:t.target});r.render(),c.find(".loading").hide(),s(e).data("commentsView",r)};p(),SNB.currentUser.isGuest&&SNB.Comment.showLoginTip(c)}break;case"tablet":}},reportSpam:function(t){switch(this.app){case"desktop":t.preventDefault();var e=s(t.target),i=e.attr("data-id"),a=this.collection.get(i).toJSON()||{},n=e.closest("li#status_"+a.id),o=a.title||"",r=a.description||"",d={id:i,type:0,user_name:a.user.screen_name,img:a.user&&a.user.img,title:o,content:r},l=s.noop();"jade-singleStock"===$body.attr("id")&&(l=function(){n.hide()}),"jade-singleStock"!==$body.attr("id")&&a.user.id||(d.isStockStatus=!0),SNB.Util.reportSpam(d,l);break;case"tablet":}},retweet:function(t){switch(this.app){case"desktop":t.preventDefault();var e=s(t.target).attr("data-id"),i=this;SNB.Util.checkLogin(function(){seajs.use("SNB.repostDialog.js",function(a){a(i.collection.get(e).toJSON(),function(e){"object"!=typeof e&&(e=s.parseJSON(e)),e.id&&(t.target.innerHTML=SNB.Util.updateCount(t.target.innerHTML),"my-home"==s("body").attr("id")&&(SNB.data.tempStatus.push(e.id),SNB.data.stCollection.add(e),SNB.data.stCollection.trigger("addStatuses",[SNB.data.stCollection.get(e.id)]),SNB.data.stView.refreshTime()))})})});break;case"tablet":}},share:function(t){switch(this.app){case"desktop":t.preventDefault();var e=s(t.target).attr("data-id"),i=this,a=i.collection.get(e).toJSON();SNB.Util.shareDialog(a,function(){});break;case"tablet":}},fav:function(t){switch(this.app){case"desktop":t.preventDefault();var e=this;SNB.Util.checkLogin(function(){var i=s(t.target).attr("data-id"),a=e.collection.get(i);a.get("favorited")?SNB.Util.confirmDialog("确定取消收藏吗？",function(){a.fav(function(){if(s(t.target).html("收藏"),"1"===s(t.target).attr("canRemove")){var e=s(t.target).closest("li");e.fadeOut(300,function(){e.remove()})}})}).dialog({modal:!0,width:200,minHeight:50,position:[t.clientX-95,t.clientY-110]}).siblings(".ui-dialog-titlebar").remove():(a.fav(function(){s(t.target).html("取消收藏")}),SNB.Util.stateDialog("收藏成功",2e3,function(){},!1,150,[t.clientX-95,t.clientY-90]))});break;case"tablet":}},"delete":function(t){switch(this.app){case"desktop":t.preventDefault();var e=s(t.target).attr("data-id"),i=this.collection.get(e),a=this;SNB.Util.checkLogin(function(){SNB.Status.destroy(t,i.id,function(){return a.collection.remove(i),!1})},t);break;case"tablet":}},edit:function(t){switch(this.app){case"desktop":t.preventDefault();var e=s(t.target).attr("data-id"),i=this.collection.get(e);SNB.Util.checkLogin(function(){seajs.use("SNB.status-edit.js",function(t){t(i.toJSON(),function(t){var e=t.user,a=e.profile_image_url?e.profile_image_url.split(","):"";t.user={img:SNB.domain.photo+"/"+(a.length>3?a[2]:1==a.length?a[0]:"community/default/avatar.png!50x50.png"),id:e.id,profile:e.profile,screen_name:e.screen_name,verified:e.verified,verified_type:e.verified_type,verified_description:e.verified_description},t.text=SNB.helpers.parseLongUrl(t.text),t.description=SNB.helpers.parseLongUrl(t.description),t.createdAt=SNB.Util.parseTime(t.created_at);var n;t.retweeted_status=n,t.notLazy=!0,s.browser.isPad||s.browser.isMobile||SNB.Util.statusPdf(t),i.set(t)})})},t);break;case"tablet":}},addStatuses:function(t){switch(this.app){case"desktop":var e=s("<div>"),i=s(this.el),a=this,n=i.data("loadOldStatus");s.each(t,s.proxy(function(t,i){var s=new SNB.Views.Status({model:i,app:a.app,id:"status_"+i.id});e.append(s.render().el)},this));var o=_.pluck(this.collection.models,"id"),r=_.pluck(t,"id");_.min(r)===_.min(o)||n?(i.find("li.last").addClass("laster"),i.find(".status-list").append(e.children()),i.find("li").filter(":last").addClass("last")):i.find(".status-list").prepend(e.children());break;case"tablet":var e=s("<div>"),i=s(this.el),a=this,d=i.data("$listView"),n=i.data("loadOldStatus");s.each(t,s.proxy(function(t,i){_.isEmpty(a.status_type)||i.set(a.status_type);var s=new SNB.Views.Status({model:i,app:a.app,id:"status_"+i.id});e.append(s.render().el)},this));var o=_.pluck(this.collection.models,"id"),r=_.pluck(t,"id");_.min(r)===_.min(o)||n?(i.find("li.last").addClass("laster"),d.find(".status-list")[0].$el.append(e.children()),d.$el.css("height","auto"),i.find("li").filter(":last").addClass("last")):(d.find(".status-list")[0].$el.prepend(e.children()),d.$el.css("height","auto"))}},refreshTime:function(){switch(this.app){case"desktop":s(this.el).find("a.time").each(function(){var t=s(this);t.text(SNB.Util.parseTime(t.attr("date")))});break;case"tablet":}},update:function(t){switch(this.app){case"tablet":case"desktop":var e=s(this.el),i=this;if(t||(t={}),this.updating)return;this.updating=!0;var a={};if(SNB.data.source&&(a.source=SNB.data.source),t.older){e.data("loadOldStatus",!0);var n=this.collection.models,o=function(){var t=[];return _.each(n,function(e){console.log(e.mark,"model.mark",typeof e.mark),("undefined"==typeof e.mark||0==e.mark)&&t.push({id:e.id,mark:e.mark})}),t.sort(function(t,e){return t.id-e.id})}();a.max_id=o.length>0?o[0].id:-1,"Infinity"==a.max_id&&(a.max_id=-1)}else{if(e.data("loadOldStatus",!1),a.since_id=_.max(_.difference(_.pluck(this.collection.models,"id"),SNB.data.tempStatus)),SNB.data.newStatuses&&SNB.data.newStatuses.length>0){var r=_.max(_.pluck(SNB.data.newStatuses,"id"));r>a.since_id&&(a.since_id=r)}"-Infinity"==a.since_id&&(a.since_id=0)}a.count=t.count||10,"undefined"!=typeof t.data&&(a="undefined"!=typeof t.data_extend?_.extend(a,t.data):t.data),t.data&&t.data.no_maxId&&(delete a.max_id,delete a.no_maxId);var d=t.params||{};if(d.older=t.older,t.older){e.addClass("processing");{this.collection.length}this.collection.fetch({url:t.url,data:a,show:!0,el:i.el,params:d,count:a.count,success:s.proxy(function(i){t.success&&t.success(i),e.removeClass("processing"),this.updating=!1},this),error:s.proxy(function(){this.updating=!1,window.console&&(console.log(arguments),console.log("服务器错误"))},this)})}else this.collection.fetch({url:t.url,data:a,show:!1,count:a.count,params:d,el:i.el,success:s.proxy(function(e,i){this.updating=!1,"object"!=typeof i&&(i=s.parseJSON(i)),"talk"===t.type?i.statuses=_.filter(i.statuses,function(t){return"object"==typeof t&&!t.blocked}):i=_.filter(i,function(t){return"object"==typeof t&&!t.blocked}),i&&(SNB.data.newStatuses="talk"===t.type?_.union(i.statuses||[],SNB.data.newStatuses||[]):_.union(i||[],SNB.data.newStatuses||[]),t.success&&t.success(),SNB.data.newStatuses.length&&(SNB.data.tempStatus.length==SNB.data.newStatuses.length?(SNB.data.tempStatus=[],delete SNB.data.newStatuses):"talk"===t.type&&SNB.data.newStatuses.length?s(".showNewStatuses").show().find(".num").text(SNB.data.newStatuses.length):SNB.data.newStatuses.length>SNB.data.tempStatus.length&&s(".showNewStatuses").show().find(".num").text(SNB.data.newStatuses.length-SNB.data.tempStatus.length)))},this),error:s.proxy(function(){this.updating=!1,window.console&&(console.log(arguments),console.log("服务器错误"))},this)})}},render:function(){switch(this.app){case"desktop":var t=s("<ul class='status-list'>");_.each(_.first(this.collection.models,8),function(e){if(!e.get("blocked")){var i=new SNB.Views.Status({model:e,id:"status_"+e.id});t.append(i.render().el)}}),s(this.el).html(t);var e=s("<div>");_.each(_.rest(this.collection.models,8),function(t){if(!t.get("blocked")){var i=new SNB.Views.Status({model:t,id:"status_"+t.id});e.append(i.render().el)}}),t.append(e.children()),t.find("li").filter(":last").addClass("last");var i=this;setInterval(function(){i.refreshTime()},3e4);break;case"tablet":var a=new infinity.ListView(s(this.el)),t=s("<ul class='status-list'>"),n=this;if("undefined"==typeof n.$el&&(n.$el=s(this.el)),_.each(this.collection.models,function(e){if(!e.get("blocked")){_.isEmpty(n.status_type)||e.set(n.status_type);var i=new SNB.Views.Status({model:e,app:"tablet",id:"status_"+e.id});t.append(s(i.render().el))}}),a.append(t),"home"===n.timeLine_type){var o=s('<div class="scrollable">'),r=s('<div class="wrap"></div>');o=o.append(r),s(n.el).wrapInner(o),s(n.el).find(".scrollable").height(s(window).height()).pullToRefresh({callback:function(t){var e=s.Deferred();return n.update({url:"/statuses/home_timeline.json",older:!1,count:10,el:s(n.el),params:{addStorage:!0,key:n.key},success:function(){n.collection.more(SNB.data.newStatuses),t&&t(SNB.data.newStatuses.length),SNB.data.newStatuses=[],SNB.Util.callBrick({homeTimelineUpdated:1})
},fail:function(){}}),setTimeout(function(){e.resolve()},3e3),e.promise()}}),s(".scrollable").find(".loading.up").length||s(".scrollable").append("<p class='up loading'><p>"),"home"===n.timeLine_type&&s(".scrollable").find(".loading.up").height(40).show().text("加载更多...")}if(a.$el.css("height","auto"),this.$el.data("$listView",a),n.drag_support){var d=!1,l={};$doc.height()>$win.height()&&s(n.el).findOrAppend(".loading.up.tablet","<p class='loading up tablet' style='height:40px;'>加载更多...</p>"),s(this.el).find(".status-list").on("touchend",function(){var t=this,e=!1,i=s(n.el);if("home"===n.timeLine_type?(i=s(".scrollable"),e=s(".scrollable").scrollTop()&&s(".scrollable").scrollTop()+$win.height()>s(t).height()-10):e=$win.scrollTop()&&$win.scrollTop()+$win.height()>$doc.height()-20,e){if(d)return;d=!0;var a=s(n.el).find(".loading.up.tablet");a.show(),n.update({url:n.url,older:!0,count:10,el:s(n.el),data:n.data,data_extend:n.data_extend||!1,params:{addStorage:!1,key:n.key},success:function(t){return t.length===l.length?void a.hide():(l.length=t&&t.length,n.data&&n.data.page&&n.data.page++,void(d=!1))},fail:function(){d=!1}})}})}}},remove:function(t){switch(this.app){case"desktop":s(this.el).find("#status_"+t.id).remove();break;case"tablet":}}}),SNB.Status={attachEvent:function(t){var e=t&&t.$el,e=e.closest("#main").length?e.closest("#main"):e,i=t&&t.app_type;if("tablet"===i){var a=function(e){var i=e.split("/"),a=t.collection.get(i[i.length-1]),s=a&&a.attributes;return s=_.isObject(s)&&s.status||s},n=function(){e.hammer().off("holdend",".status-list li").on("holdend",".status-list li",function(){if(SNB.isScrolling)return!1;if(s(this).data("holding")){s(this).css({"background-color":"#f0f0f0"});var t=s(this).find(".createdAtTime").attr("data-target"),e="http://xueqiu.com"+t,i=a(t),n={link:e};_.isEmpty(i)||(n.status=i),SNB.Util.callBrick(n)}s(this).data("holding",!1)}).off("hold",".status-list li").on("hold",".status-list li",function(){return SNB.isScrolling?!1:(s(this).data("holding",!0),void s(this).css({"background-color":"#e8e8e8"}))}).off("tap",".status-list li").on("tap",".status-list li",function(t){if(SNB.isScrolling)return!1;s(this).css({"background-color":"#e8e8e8"});var e=this,i="";setTimeout(function(){s(e).css({"background-color":"#f0f0f0"})},500);var n=s(t.target).parent()[0],o=s(e).find(".createdAtTime").attr("data-target"),r=s(e).find(".createdAtTime").attr("data-id");if("A"!==t.target.tagName&&"A"!==n.tagName){i="http://xueqiu.com"+o,i="-1"===i.search("#")?i.substr(0,i.search("#")):i;var d=a(r||o),l={link:i};_.isEmpty(d)||(l.status=d),SNB.Util.callBrick(l)}}).off("click",".status-list li a").on("click",".status-list li a",function(t){t.preventDefault();var e=this.href;if(e&&"#"!=e){var i=s(this).closest("li"),n=i.find(".createdAtTime").attr("data-target"),o=a(n);(e.match(/\/n\//)||e.match(/\k\?q=/))&&(e=decodeURIComponent(e));var r={link:e};_.isEmpty(o)||(r.status=o),SNB.Util.callBrick(r)}}).off("drag",".status-list li").on("drag",".status-list li",function(){s(this).data("holding",!1),s(this).css({background:"#f0f0f0"})})},o="undefined"!=typeof s.hammer;o?n():s.getScript("http://assets.imedao.com/js/jquery.hammer.js").done(function(){n(),o=!0}).fail(function(){o=!1})}},expandStatus:function(t,e){function i(t,i,a){var n=t.find(".flexpaper_viewer"),o="flexpaper_viewer_"+Math.random().toString().substring(2);if(n.length){var r=n.find(".fp_wrapper"),d=r.data("mask");if(r.data("mask_removed",!1),!d||!d.length)return;n.append(d),d.show(),d.find(".flexpaper_hint").show(),setTimeout(r.data("show"),2e3)}else{n=s('<div class="flexpaper_viewer"><div class="fp_wrapper" id="'+o+'"></div><div class="flexpaper_mask"><div class="flexpaper_p"><div class="flexpaper_hint"><img src="http://assets.imedao.com/images/ajax-loader.gif" />&nbsp;正在加载&nbsp;<span class="fp_loaded">0%</span></div></div></div></div>'),n.data("pdf",i);var l=t.find("span.fold-all,span.fold-retweet");l.is(".fold-retweet")&&l.before("<br>"),l.before(n),n.before("<br>"),SNB.Util.pdfLink(n,a?e.get("retweeted_status").target:e.get("target"),a?e.get("retweeted_status").title:e.get("title"));var o=o;SNB.Util.pdfViewer(o,i)}}var a=s(t),n=a.find(".detail"),o=a.find(".summary");if(a.find(".show-all").click(function(){if(n.find("img.ke_img").each(function(){var t=this,e=s(t).attr("data-image");e&&(s(t).attr("src",e),s(t).removeAttr("data-image"))}),n.show(),o.hide(),!n.find(".zoom").length){var t=n.find("img");t.each(function(){SNB.Image.zoomIn(s(this))})}var a=e.get("pdf");a&&!e.get("retweeted_status")&&i(n,a,!1)}),a.find(".fold-all, .detail .ke_img").click(function(){n.hide(),o.show(),s(this).hasClass("noshow")&&a.find("img.show-all,img.show-retweet").hide();var t;$win.scrollTop()>(t=a.offset().top)&&$win.scrollTop(t-40)}),a.find(".retweet").length>0){var r=a.find(".retweet .re-detail"),d=a.find(".retweet .re-summary"),l=e.get("retweeted_status");a.find(".show-retweet").click(function(){if(r.find("img.ke_img").each(function(){var t=this,e=s(t).attr("data-image");e&&(s(t).attr("src",e),s(t).removeAttr("data-image"))}),r.show(),d.hide(),!r.find(".zoom").length){var t=r.find(".ke_img");t.each(function(){SNB.Image.zoomIn(s(this))})}var e=l.pdf;e&&i(r,e,!0)}),a.find(".fold-retweet, .re-detail .ke_img").click(function(){r.hide(),d.show();var t;$win.scrollTop()>(t=a.offset().top)&&$win.scrollTop(t-40)})}},destroy:function(t,e,i){var a=s("#dialog-delete-status");if(a.length<1){var n='<div id="dialog-delete-status" class="dialog-wrapper"><div class="tipsdivcontent" style="text-align:center;"><p class="message" style="text-align:center;">确定删除吗？</p><div><input type="button" class="submit okButton" value="确定"/><input type="button" class="button cancelButton" value="取消"/></div></div></div>';s("body").append(n),a=s("#dialog-delete-status"),a.find(".cancelButton").click(function(){a.dialog("close")})}a.find(".okButton").unbind("click").bind("click",function(){a.dialog("close"),SNB.post("/statuses/destroy/"+e+".json",function(){i&&i()},function(){alert("删除失败！")})});var o=s(t.target);a.dialog({modal:"true",minHeight:50,width:200,position:[o.offset().left-110,o.offset().top-s(document).scrollTop()-110]}).prev().hide()}},SNB.Status.cleanUser=function(t,e){return{img:SNB.Image.getProfileImage(t.profile_image_url,e&&e.img_size),img_100:SNB.Image.getProfileImage(t.profile_image_url,100),id:t.id,profile_image_url:t.profile_image_url,profile:t.profile,truncated:t.truncated,screen_name:t.screen_name,following:t.following,remark:t.remark||"",verified:t.verified,verified_type:t.verified_type,verified_description:t.verified_description}},SNB.Models.Comment=Backbone.Model.extend({sync:function(t,e,i){switch(t){case"create":var a={id:e.get("statusId"),comment:e.get("comment"),_:(new Date).getTime(),forward:e.get("forward")};"undefined"!=typeof SNB.data.comment_module_id&&(a.module_id=SNB.data.comment_module_id),i.url="/service/poster",i.type="post",i.data={url:"/statuses/reply.json",data:a},e.get("in_reply_to_comment_id")&&(i.data.data.cid=e.get("in_reply_to_comment_id"),i.data.data.split=!0);break;case"delete":i.url="/service/poster",i.data={url:"/comments/destroy/"+e.get("id")+".json?_="+(new Date).getTime()},i.type="post";break;case"update":i.url="/service/poster",i.type="post",i.data={url:"/comments/edit.json",data:{text:e.get("text"),id:e.get("id"),_:(new Date).getTime(),split:!0}},i.success=function(t){var a=s.parseJSON(t);e.set({text:a.text}),i.callback&&i.callback()},i.error=function(t){var e=t&&t.responseText;e=s.parseJSON(e),SNB.Util.failDialog(e&&e.error_description||"保存出错，请稍后重试")}}return s.ajax(i)},parse:a}),SNB.Collections.Comments=Backbone.Collection.extend({model:SNB.Models.Comment,initialize:function(t,e){this.app="undefined"==typeof e||"object"==typeof e&&"undefined"==typeof e.app?"desktop":e.app,this.statusId=e.statusId,this.commentLink=e.commentLink,this.commentContainer=e.commentContainer,this.in_reply_to_comment_id=e.in_reply_to_comment_id,this.page=this.page?this.page:e.page?e.page:1,this.maxPage=this.maxPage?this.maxPage:e.maxPage?e.maxPage:1,this.url="undefined"!=typeof e.url&&e.url?e.url:SNB.domain.base+"/statuses/comments.json?split=true&id="+e.statusId},updateCount:function(t){switch(this.app){case"desktop":if(this.commentContainer){var e=this.commentContainer.find(".counts");this.commentLink.innerHTML=SNB.Util.updateCount(this.commentLink.innerHTML,t),e.text(SNB.Util.updateCount(e.text(),t))}break;case"tablet":}},parse:function(t){var e="string"==typeof t?s.parseJSON(t):t;return this.maxPage=e.maxPage,this.page=e.page,_.map(e.comments,a)}}),SNB.Templates.Comment='<div class="headpic"><a target="_blank" href="'+SNB.domain.host+'{{=it.user.profile}}" target="_blank" data-name="{{=it.user.screen_name}}"><img width="30px" height="30px" src="{{=it.user.img}}"></a></div><div class="content"><div class=\'comment\'><a href="'+SNB.domain.host+'{{=it.user.profile}}" target="_blank" data-name="{{=it.user.screen_name}}">{{=it.user.screen_name}}<span class="user_remark" data-name="{{=it.user.screen_name}}" style="{{=it.user.remark ? "display:inline" : "display:none" }}">{{ if(it.reply_remark){ }}({{=it.reply_remark}}){{ } }}</span>{{ if (it.user.verified){ }}<img width=\'16px\' height=\'16px\'  class=\'vipicon\' title=\'{{=it.user.verified_description}}\' src=\''+SNB.domain["static"]+"/images/vipicon_{{=it.user.verified_type || 1}}.png'/>{{ } }}</a>{{ if(it.reply_screenName) { }} 回复 <a href='"+SNB.domain.host+"/n/{{=it.reply_screenName}}' target='_blank'>{{=it.reply_screenName}}<span class=\"user_remark\" data-name=\"{{=it.reply_screenName}}\" style=\"{{=it.reply_remark ? \"display:inline\" : \"display:none\" }}\">{{ if(it.reply_remark){ }}({{=it.reply_remark}}){{ } }}</span>{{ if (it.reply_verified){ }}<img width='16px' height='16px'  class='vipicon'  title='{{=it.reply_verified_description||''}}' src='"+SNB.domain["static"]+'/images/vipicon_{{=it.reply_verified_type||1}}{{= it.app_type === \'tablet\' ? \'@2x\' : \'\'}}.png\'/>{{ } }}</a>：{{ } }}{{ else{ }}：{{ } }}</div><div class=\'cmt_con\'><span>{{ if(!it.truncated && !it.blocking) { }}{{=it.text}}{{ }else { }}<i>{{=it.text}}</i>{{ } }}</span></div><div class="ops"><div class=\'infos\'><span class="createAt" createdat="{{=it.created_at}}">{{=it.createdAt}}</span>{{ if ((it.user.id !== {{#def.uid}})) { }}<a href="#" class="reportSpam_comment last">举报</a>{{ } }}</div>{{ if(!it.truncated) { }}{{ if ((it.user.id == {{#def.uid}}) && it.canEdit) { }}<a href="#" class="editComment">修改</a>{{ } }}{{ if({{#def.uid}}){ }}{{ if (it.user.id == {{#def.uid}} || {{#def.uid}} == {{#def.status_user_id}} || {{#def.uid}} == {{#def.retweeted_status_user_id}}) { }}{{ if(it.user.id !== {{#def.uid}}) { }}<a href="#" class="deleteComment" canBlock="true" blockUserId="{{=it.user.id}}">删除</a> {{ }else { }}<a href="#" class="deleteComment">删除</a> {{ } }}{{ } }}{{ } }}{{ if(it.reply_screenName) { }}<a href="#" class="talk">查看对话</a>{{ } }}{{ if(it.user.id != {{#def.uid}}) { }}<a href="#" class="btn-donate" data-id="{{= it.id }}">{{ } else { }}<a href="#" class="btn-donate self" data-id="{{= it.id }}">{{ } }}赞助{{ if (it.donate_snowcoin) { }}<span class="number">(<em class="snow-coin" data-count="{{#def.coin}}">{{#def.coin}}</em>)</span>{{ } else { }}<span class="number" style="display:none;">(<em class="snow-coin" data-count="0">0</em>)</span>{{ } }}</a><a href="#" class="reply last">回复</a>{{ } }}</div></div>{{ if ((it.user.id == {{#def.uid}}) && it.canEdit) { }}<div style="display:none" class="editarea"><textarea class="comment_edit"></textarea><div class="ops"><span class="showFaceButton">&nbsp;</span><span class="addStock">&nbsp;</span><a href="#" class="comment_cancel">取消</a><input type="button" class="button comment_save" value="保存"/></div></div>{{ } }}',SNB.Views.Comment=Backbone.View.extend({initialize:function(t){this.app="undefined"==typeof t||"object"==typeof t&&"undefined"==typeof t.app?"desktop":t.app,this.model.statusId=t&&t.statusId,_.bindAll(this,"render"),this.model.bind("destroy",this.remove,this)},tagName:"li",events:{"click .editComment":"edit","click .talk":"talk","click .reply":"reply","click .like":"like","click .unlike":"unlike","click .reportSpam_comment":"reportSpam","click .deleteComment":"destroy","click .submit_reply":"submit_comment","click .comment_cancel":"cancel","click .comment_save":"save","click .btn-donate":"donate"},render:function(){switch(this.app){case"desktop":var t=this.model.toJSON();if(t.blocked||t.user&&t.user.truncated)return{};var e=t.donate_snowcoin;return e>9999&&(e=e%1e4>99?(e/1e4).toFixed(2)+"万":Math.floor(e/1e4)+"万"),SNB.Templates.commentFunc=doT.template(SNB.Templates.Comment,void 0,{uid:SNB.currentUser.id||0,uname:SNB.currentUser.screen_name,status_user_id:SNB.data.status_user_id,retweeted_status_user_id:SNB.data.retweeted_status_user_id||0,coin:e}),s(this.el).html(SNB.Templates.commentFunc(this.model.toJSON())),this.$(".content").show(),this.$(".editarea").hide(),this;case"tablet":}},like:function(t){switch(this.app){case"desktop":t.preventDefault();var e=this.model.id,i=s(t.target),a=i.attr("like_count"),n=parseInt(a)+1;SNB.Util.checkLogin(function(){i.data("processing")||(i.data("processing",1),SNB.post("/comments/like.json",{id:e},function(){i.data("processing",0),i.text("已赞("+n+")").removeClass("like").addClass("unlike").attr("like_count",n)},function(t){i.data("processing",0),SNB.Util.failDialog(t.error_description)}))});break;case"tablet":}},unlike:function(t){switch(this.app){case"desktop":t.preventDefault();var e=this.model.id,i=s(t.target),a=i.attr("like_count"),n=parseInt(a)-1;SNB.Util.checkLogin(function(){i.data("processing")||(i.data("processing",1),SNB.post("/comments/unlike.json",{id:e},function(){i.data("processing",0);var t=a>1?"("+n+")":"";i.text("赞"+t).removeClass("unlike").addClass("like").attr("like_count",n)},function(t){i.data("processing",0),SNB.Util.failDialog(t.error_description)}))});break;case"tablet":}},edit:function(e){switch(this.app){case"desktop":var i=this;e.preventDefault(),e.stopPropagation(),this.$(".content").hide();var a=SNB.Util.reparseContent(this.model.get("text").replace(/<br\/?>/gi,"\n").replace(/&nbsp;/gi," ")),i=this;t.async("SNB.editor.js",function(t){var e=i.ta=t.init(i.$(".editarea"),{autoResize:50,content:a,$emotion:i.$(".showFaceButton"),$stock:i.$(".addStock"),focus:!0,ctrlReturn:!0,submitFunc:function(){i.$(".comment_save").trigger("click")}});s.browser.isMobile||e.upgrade()});break;case"tablet":}},talk:function(t){switch(this.app){case"desktop":t.preventDefault();var e=this,i={id:e.model.get("retweet_status_id")||e.model.get("root_in_reply_to_status_id"),comment_id:e.model.get("id"),count:20,asc:"false"},n=s("<div id='dialog_talk' class='dialog_talk'><div class='talkContainer commentContainer'><div style='display:none' class='loading_talk loading'>正在加载对话...</div><div class='talk_bd'></div></div></div>");s("#dialog_talk").length?(n=s("#dialog_talk"),n.find(".talk_bd").empty().end().find(".talkContainer").removeClass("showScrollBar").end().dialog()):n.dialog({title:"查看对话",modal:!0,minHeight:50,height:"auto",width:558}),n.closest(".ui-dialog").css({position:"fixed",top:document.documentElement.clientHeight-650<0?"75px":"150px"});var o=function(t){n.find(".loading_talk").show().end().find(".talk_bd").empty().end().find(".talkContainer").removeClass("showScrollBar"),SNB.get("/statuses/talks.json",t,function(r){n.find(".loading_talk").hide();var d=s(".dialog_talk .talkContainer"),l=d.find(".talk_bd");if(0===r.comments.length)return void l.html("<p class='notalks'>对话原文已被删除</p>");_.chain(r.comments).reverse().map(function(t){a(t)});var c=new SNB.Collections.Comments(r.comments,{statusId:t.id,page:r.page,maxPage:r.maxPage,commentLink:s(".statusComment")[0],commentContainer:l}),p=s("<ul class='commentList talkList'> </ul>");if(c.each(function(t){p.append(new SNB.Views.Comment({model:t,id:"comment_"+t.id,statusId:e.model.statusId}).render().el)}),l.append(p),p=l.find(".commentList"),p.on("click",".reply",function(t){var e=s(t.target).offset().top,i=l.offset().top,a=n.find(".talkContainer").scrollTop(),o=e-i-a;temp=158-(400-o),temp>0&&d.scrollTop(a+temp)}),d.on("mousewheel",function(t){t.stopPropagation(),t.preventDefault();var e=s(this)[0].scrollTop;return s(this).scrollTop(e-t.originalEvent.wheelDelta/5),!1}),c.maxPage>1)p.append(s(SNB.Pager(c.page,c.maxPage)).find("a").on("click",function(t){t.preventDefault();var e=s(t.target),a=e.attr("data-page");i.page=a,o(i)}).end());else{var u=p.find("#comment_"+c.last().id);u.addClass("last"),setTimeout(function(){u.css("background-color","#fff")},200)}p.height()>400&&d.addClass("showScrollBar").scrollTop(p.height())})};o(i);break;case"tablet":}},reportSpam:function(t){switch(this.app){case"desktop":t.preventDefault();var e=this,i={id:e.model.get("id"),type:1,user_name:e.model.get("user")?e.model.get("user").screen_name:"",img:e.model.get("user")?e.model.get("user").img:"http://photo.xueqiu.com/community/default/avatar.png!50x50.png",title:"",content:e.model.get("description")};SNB.Util.reportSpam(i,function(){});break;case"tablet":}},reply:function(e){switch(this.app){case"desktop":e.preventDefault();var i=this;SNB.Util.checkLogin(function(){var e=i.el;return s(e).hasClass("display_textarea")?(s(e).find(".commentPostArea").toggle(),void(ta&&ta.reset("",!0))):(s(e).append(SNB.Templates.commentPostArea).addClass("display_textarea"),i.$(".commentSubmit").removeClass("commentSubmit").addClass("submit_reply"),i.statusId=i.model.statusId,i.in_reply_to_comment_id=i.model.get("id"),void t.async("SNB.editor.js",function(t){ta=i.ta=t.init(i.$(".inputArea"),{$emotion:i.$(".showFaceButton"),$stock:i.$(".addStock"),ctrlReturn:!0,submitFunc:_.bind(function(){i.$(".submit_reply").click()},i,{}),autoResize:50});var e=s(i.el).closest("body");e.is("#widget-comment")&&s.browser.msie&&e.addClass("ie"),s.browser.isMobile||ta.upgrade(function(){ta.reset("",!0)})}))});break;case"tablet":}},submit_comment:function(t){switch(this.app){case"desktop":t.preventDefault();var e=this;e.submitBtn=e.$("input[type='submit']"),SNB.Comment.submit_comment(e,t);break;case"tablet":}},destroy:function(t){switch(this.app){case"desktop":var e=this,i=s(t.target),a=i.attr("canBlock"),n=a?20:0;return SNB.Util.deleteDialog(t.target,function(){e.model.collection.updateCount(-1),e.model.destroy(),e.remove()}).dialog({modal:"true",minHeight:50,width:200,position:[i.offset().left-100,i.offset().top-s(document).scrollTop()-105-n]}).prev().hide(),!1;case"tablet":}},cancel:function(t){switch(this.app){case"desktop":t.preventDefault(),this.$(".content").show(),this.$(".editarea").hide();break;case"tablet":}},save:function(t){switch(this.app){case"desktop":t.preventDefault();var e=this,i=SNB.Util.cleanContent(e.ta.getContent(),!1,e.ta.editor);e.model.save({text:i},{callback:function(){e.render()}});break;case"tablet":}},donate:function(t){function e(t){var e=t.profile_image_url.split(","),i=SNB.domain.host+t.profile,a=e[0].replace("!50x50.png","");return{id:t.id,name:t.screen_name,avatar:SNB.domain.photo+"/"+a+"!100x100.png",url:i}}function i(t){var e='<li class="donator-item donator-'+d.id+'"><a href="'+d.url+'" data-name="'+d.name+'"><img src="'+d.avatar+'" width="30"></a></li>',i=s(r.el).find(".comment-donator-list"),a=s(r.el),n=a.find(".donators-tip"),o=a.find(".ops .number"),l=a.find(".donators-count"),c=a.find(".snow-coin:first");n.show(),o.show();var p=c.data("count")||0;if(p=p-0+(t-0),a.find(".snow-coin").data("count",p),p>9999&&(p=p%1e4>99?(p/1e4).toFixed(2)+"万":Math.floor(p/1e4)+"万"),a.find(".snow-coin").text(p),!i.find(".donator-"+d.id).length){i.append(e);var u=l.text()-0+1;l.text(u)}}t.preventDefault();var a=s(t.target).is(".btn-donate")?s(t.target):s(t.target).parents(".btn-donate");if(clearTimeout(a.data("timeout")),a.is(".self"))return!1;var o=this.model.toJSON(),r=this,d=e(SNB.currentUser),l={id:o.id,type:"comment",user:o.user,uri:SNB.data.status?SNB.domain.host+SNB.data.status.target+"#"+o.id:a.parents("li").find(".status_content .time").attr("href")+"#"+o.id,status:SNB.data.status};SNB.Util.checkLogin(function(){n(l,function(t){i(t)})})}});var d,l;SNB.Templates.commentPostArea='<div class="commentPostArea"><div class="arrow-top"><span class="arrow-top-out"></span><span class="arrow-top-in"></span></div><div class="inputArea"><textarea class="commentEditor" ></textarea></div><p class="forbidden" style="display:none">由于用户的设置，你不能对主贴进行评论</p><span class="showFaceButton">&nbsp;</span><span class="addStock">&nbsp;</span><label><input type="checkbox" name="forward"/>同时转发到我的首页 </label><form class="replyForm" action="" method="get" ><input type="submit" class="commentSubmit button"  value="发布"/></form><div class="fixit"></div></div>',SNB.Templates.Comments=SNB.Templates.commentPostArea+"<div class='loading' style='display:none'></div><div class='goodCommentInfo' data_limit=1 style='display:none'><h4 class='hd'>精彩评论</h4><ul class=\"commentList\"></ul></div><div class='commentInfo' style='display:none'><div class='hd'><span class='sort'><span>排序：</span><a href='javascript:;' sort='false' class='active' title='最近'>最近</a><a href='javascript:;' sort='true' title='最早'>最早</a><a href='javascript:;' sort='like' title='赞' class='last'>赞助</a></span><span class='commentNum'>全部评论<span class='counts'></span></span></div><div class='loading' style='display:none'></div><ul class=\"commentList\"></ul></div>",SNB.Views.CommentInfo=Backbone.View.extend({initialize:function(t){this.app="undefined"==typeof t||"object"==typeof t&&"undefined"==typeof t.app?"desktop":t.app,this.statusId=t&&t.statusId,this.collection.view=this,this.collection.bind("reset",this.render,this),this.collection.bind("add",SNB.Comment.addComment,this),this.collection.commentTo=t.commentTo},events:{"click .sort a":"sortComments"},render:function(){switch(this.app){case"desktop":var t=this,e=s(t.el),i=e.closest(".commentContainer"),a=t.collection.length,n=(t.collection.commentLink,s("<ul class='commentList'></ul>"));t.collection.each(function(e){e.get("user")&&n.append(new SNB.Views.Comment({model:e,id:"comment_"+e.id,statusId:t.statusId,parentView:t}).render().el)}),"1"===e.attr("data_limit")&&(t.collection.maxPage=1),t.collection.maxPage>1?n.append(s(SNB.Pager(this.collection.page,this.collection.maxPage,{jump:!0})).find("a").click(function(i){i.preventDefault();var a=s(this).attr("data-page");SNB.Comment.emptyCommentList(t.$(".commentList")),$body=s.browser.webkit?$body:s("html"),$body.animate({scrollTop:e.offset().top-30},200),e.find(".loading").show(),t.collection.fetch({data:{page:a,asc:SNB.data.sort||"false"}})}).end()).delegate(".jump_input input","keydown",function(i){if(13==i.keyCode){var a=s(this).val(),n=this;if(a="string"==typeof a?parseInt(a):a,isNaN(a)||a>t.collection.maxPage)return void SNB.Util.failDialog("请输入正确的页码",null,function(){s(n).select()});e.find(".loading").show(),t.collection.fetch({data:{page:a,asc:SNB.data.sort||"false"}}),SNB.Util.scrollTop(e,{top:45})}}):n.find("li:last").addClass("last"),setTimeout(function(){i.find(".loading").hide()},1),a&&(e.find(".commentList").replaceWith(n).end().show(),SNB.Comment.renderNoComment(t.collection,e));break;case"tablet":}},sortComments:function(t){switch(this.app){case"desktop":t.preventDefault();var e=t.target,i=this,a=(s(e).parent(".sort"),s(e).attr("sort"));s(e).addClass("active").siblings().removeClass("active"),SNB.Comment.emptyCommentList(i.$(".commentList")),i.$(".loading").show(),SNB.data.sort=a,i.collection.url="like"===a?"/service/comments_by_donate?id="+i.collection.statusId:"/service/comments?split=true&asc="+a+"&id="+ +i.collection.statusId,i.collection.fetch();break;case"tablet":}}}),SNB.Views.Comments=Backbone.View.extend({initialize:function(t){this.app="undefined"==typeof t||"object"==typeof t&&"undefined"==typeof t.app?"desktop":t.app,this.collection.view=this,this.collection.bind("reset",this.render,this),this.collection.bind("add",SNB.Comment.addComment,this),this.collection.commentTo=t.commentTo,this.statusId=t.statusId||0,this.commentLink=t.commentLink},events:{"click .commentSubmit":"submitComment"},template:SNB.Templates.Comments,render:function(e){switch(this.app){case"desktop":var i=this,a=s(i.el);a.findOrAppend(".commentInfo",SNB.Templates.Comments).show(),a.find(".loading").show();var n=s(i.commentLink).text().match(/\d+/gi),o=n&&parseInt(n)||0;o&&a.find(".counts").text("（"+o+"）"),i.collection.rootStatusId=i.collection.statusId,SNB.currentUser.isGuest||SNB.get("/statuses/allow_reply.json",{status_id:i.collection.statusId},function(t){t.success||(a.find("textarea").prop("disabled","disabled"),a.find(".forbidden").show())});var r=function(t,s,n,o){var r=t&&t.comments||[],d=t&&t.page||1,l=t&&t.maxPage||1,c=new SNB.Collections.Comments(r,{url:n,page:d,maxPage:l,statusId:i.statusId,commentLink:i.commentLink,commentContainer:s}),p=new SNB.Views.CommentInfo({el:s,collection:c,statusId:i.statusId});p.render(),"function"==typeof o&&o(),1!==e&&"undefined"==typeof t&&(a.find(".commentInfo .loading").show(),c.fetch())},d=a.find(".goodCommentInfo"),l=a.find(".commentInfo");o>5&&r(SNB.data.goodComments,d,SNB.domain.base+"/statuses/comments_by_donate.json?count=5&filtered=true&id="+i.statusId,s.noop()),r(SNB.data.comments_loaded&&SNB.data.comments,l,"/service/comments?filtered=true&id="+i.statusId,s.noop());{var c;a.find("textarea")}t.async("SNB.editor.js",function(t){c=i.ta=t.init(a.find(".inputArea"),{$emotion:a.find(".showFaceButton"),$stock:a.find(".addStock"),ctrlReturn:!0,submitFunc:_.bind(function(){a.find("input.commentSubmit").click()},i,{}),autoResize:50});var e=s(i.el).closest("body");e.is("#widget-comment")&&s.browser.msie&&e.addClass("ie"),e.is("#jade-single")||e.is("#widget-comment")||s.browser.isMobile||c.upgrade()}),SNB.data.comment_forward&&a.find(".commentPostArea input[type=checkbox]").prop("checked",!0);break;case"tablet":}},toggle:function(){switch(this.app){case"desktop":var t=this,e=s(t.el);e.toggle();break;case"tablet":}},submitComment:function(t){switch(this.app){case"desktop":t.preventDefault();var e=this;e.submitBtn=s(t.target),e.statusId=e.collection.statusId,e.in_reply_to_comment_id=e.collection.in_reply_to_comment_id,SNB.Comment.submit_comment(e,t);break;case"tablet":}}}),SNB.Comment={blockUser:function(t){SNB.post("/blocks/create.json",{user_id:t},function(){})},emptyCommentList:function(t){var e=t.height()<2e3?2e3:t.height();t.height(e).empty()},renderNoComment:function(t,e){var i=t.length,a=0;t.each(function(t){t.get("blocked")&&++a}),a===i&&e.find(".commentList").html("<li class='noComment'>评论中有用户已被加入黑名单列表，其评论内容不显示。</li>")},addComment:function(t){var e=t.collection.commentContainer;e=e.closest(".commentContainer");var i=e.find(".commentInfo");i.find(".commentList").prepend(new SNB.Views.Comment({model:t,statusId:this.statusId}).render().el),i.show().find(".noComment").hide()},createComment:function(t,e,i,a){var n=t.ta;i.statusId=t.statusId,e.create(i,{success:function(e){e.collection.updateCount(1),t.$(".commentSubmit").attr("hideCommentInfo")||t.$(".commentInfo").show(),t.submitBtn.prop("disabled",!1),SNB.Util.stateDialog("回复成功",1e3,function(){},!1,110,[t.elmTarget.offset().left-45,t.elmTarget.offset().top-s(window).scrollTop()-60],110),a&&a(),n.reset("",!1)},error:function(e,i){var a=i&&i.responseText;"object"!=typeof a&&(a=s.parseJSON(a)),t.submitBtn.prop("disabled",!1),SNB.Util.failDialog(a.error_code?a.error_description:"服务器出错，请重试。")}})},submit_comment:function(t,e){e.preventDefault();var i=e.target,a=t.ta,n=t.statusId||s(t.el).data("statusId"),o=SNB.Util.cleanContent(a.getContent(),!1,a.editor);return o==d&&n==l?void SNB.Util.failDialog("重复发布评论",100):(t.statusId=n,d=o,l=n,t.submitBtn.prop("disabled",!0),void SNB.Util.checkLogin(function(){SNB.get(SNB.domain.base+"/statuses/allow_reply.json",{status_id:n},function(e){if(e.success){var a=s.trim(s(i).data("commentTo"))||"";if(!o)return SNB.Util.failDialog("评论不能为空！"),t.submitBtn.prop("disabled",!1),!1;var r=t.$("input[name=forward]:checked").length>0?1:0,d={statusId:n,comment:o,in_reply_to_comment_id:t.in_reply_to_comment_id,forward:r};if(a&&SNB.Util.isContentSame(o,a))return SNB.Util.failDialog("请输入内容再发布"),t.submitBtn.prop("disabled",!1),!1;a&&!~o.replace(/\u00a0|\u0020|&nbsp;/g,"").indexOf(a)&&delete d.in_reply_to_comment_id,s(i).is(".submit_reply")?(t.elmTarget=t.$(".reply"),SNB.Comment.createComment(t,t.model.collection,d,function(){t.$(".commentPostArea").hide()})):(t.elmTarget=s(i),SNB.Comment.createComment(t,t.collection,d))}else t.submitBtn.prop("disabled",!1),SNB.Util.failDialog("对方不允许评论")})},e))},showLoginTip:function(t){var e="<div class='loginDialog'><p>参与讨论，请先 <a href='/' id='openLoginDialog'>登录</a> | <a href='/account/reg'>注册</a></p></div>";t.find(".commentEditor").prop("disabled","disabled"),t.find(".inputArea").append(e).addClass("notlogined");var i=t.find(".loginDialog");t.find(".loginDialog").css("left",t.width()/2-i.width()/2)}}});