define("widget/donate.js",["widget/util/password","widget/util/share","SNB.repostDialog","widget/repost_comment"],function(a,t,n){function s(a){var t=_.template('<div id="donate-dialog"><div class="donate-bd"><div id="donate-wrap" class="bd-wrap"><p class="title">欢迎赞助！请选择赞助给 <%= user.screen_name %> 的金额：</p><ul class="item-list"><li class="item" data-amount="1">1雪球币</li><li class="item" data-amount="6">6雪球币</li><li class="item" data-amount="10">10雪球币</li><li class="item" data-amount="66">66雪球币</li><li class="item" data-amount="100">100雪球币</li><li class="item-custom" data-amount=""><input type="text" class="coin-amount" placeholder="其他金额" maxlength="5"></li></ul><p class="tip" style="display:none;"></p><div class="donate-ft"><a href="#" class="btns btn-donate disabled">赞助</a><a href="/c/deposit" target="_blank" class="btn-recharge">购买雪球币</a></div></div><div id="recharge-wrap" class="bd-wrap" style="display:none;"><p>请在新窗口购买雪球币，完成之前请不要关闭此窗口</p><div class="recharge-ft"><a href="#" class="btns btn-done">已完成</a><a href="/c/deposit" target="_blank" class="btns btn-redo">重新购买</a></div></div><div id="pwd-wrap" class="bd-wrap" style="display:none;"><p>你最近消费较多雪球币，为确保账户安全，</p><p>请输入登录密码进行确认:</p><p><input type="password" class="pwd" /><span class="warn" style="display:none;">密码错误</span></span></p><div class="pwd-ft">	<a href="#" class="btns btn-confirm">确认</a></div></div><div id="done-wrap" class="bd-wrap" style="display:none;"><p class="success">感谢赞助</p><p class="success-tip"><%= user.screen_name %> 已收到你赞助的 <span class="amount"></span>雪球币</p><p><a href="#" class="btn-share">分享到雪球</a></p></div></div></div>');return $(t(a))}function e(a){a._type=p[a.type];var t=_.template("我刚向 @<%= user.screen_name %> 的<%= _type %>赞助了 <%= amount %> 雪球币，<%= _type %>地址 <%= uri %>");return t(a)}function d(a,t){var n=$("#donate-wrap .tip"),s=$("#donate-wrap .btn-donate"),e="";n.hide(),a&&/^[1-9]\d*$/.test(a)?a>=5e4?(e="赞助数额不能超过50000雪球币",n.addClass("warn"),s.addClass("disabled"),n.text(e).show()):$.post("/c/balance",function(d){var i=d.snow_coin;i>=a?(e="应付:"+a+"雪球币，帐号余额:"+i+"雪球币",n.removeClass("warn"),s.removeClass("disabled"),t&&"function"==typeof t&&t()):a>i&&(e="应付:"+a+"雪球币，帐号余额:"+i+"雪球币，请先购买雪球币",n.addClass("warn"),s.addClass("disabled")),n.text(e).show()}):(e="输入数量错误，请输入整数",n.addClass("warn"),s.addClass("disabled"),n.text(e).show())}function i(a,t){return this.init(a,t)}var o=a("widget/util/password"),r=a("widget/util/share"),l=a("SNB.repostDialog"),c=a("widget/repost_comment"),p={status:"篇帖子",comment:"条评论"};i.prototype={init:function(a,t){function n(n,s){if(s.success){a.amount=n;var e="";i.dialog("close"),"comment"==a.type?(e="我刚赞助了这条评论 "+n+" 雪球币，也推荐给你。",c(a.status.id,a.id,e)):(e="我刚赞助了这篇帖子 "+n+" 雪球币，也推荐给你。",l(a.status,"",e)),t&&"function"==typeof t&&t(n)}else 21722==s.error_code?i.find(".bd-wrap").hide().end().find("#pwd-wrap").show().find(".pwd").focus().find(".amount").text(n):28015==s.error_code?i.find(".tip").show():21723==s.error_code?$("#pwd-wrap .warn").show():alert(s.error_description)}var i=s(a);return i.dialog({modal:!0,title:"赞助",width:400,close:function(){i.dialog("destroy").remove()}}),i.find(".coin-amount").blur(),i.find(".item").on("click",function(){var a=$(this),t=i.find(".btn-donate");t.removeClass("disabled"),a.siblings("li").removeClass("on"),a.addClass("on"),$(".coin-amount").val("");var n=a.data("amount");d(n),i.find(".btn-donate").data("amount",n).removeClass("validate")}),i.find(".item").eq(0).trigger("click"),i.find(".coin-amount").on("focus",function(){i.find(".tip").hide();var a=$(this),t=a.parents(".item-custom"),n=i.find(".btn-donate");n.data("amount",0).addClass("disabled"),t.addClass("on"),t.siblings("li").removeClass("on"),i.find(".tip").hide();var s=$.trim(a.val());s&&n.data("amount",s),i.find(".btn-donate").addClass("validate")}).on("keyup",function(){var a=$(this),t=a.parents(".item-custom"),n=i.find(".btn-donate"),s=$("#donate-wrap .btn-donate"),e=$("#donate-wrap .tip"),d="";n.removeClass("disabled"),t.addClass("on"),t.siblings("li").removeClass("on");var o=$.trim(a.val());return o?void(/^[1-9]\d*$/.test(o)?o>=5e4?(d="赞助数额不能超过50000雪球币",e.addClass("warn"),s.addClass("disabled"),e.text(d).show()):$.post("/c/balance",function(a){var t=a.snow_coin;t>=o?(d="应付:"+o+"雪球币，帐号余额:"+t+"雪球币",e.removeClass("warn"),s.removeClass("disabled"),s.data("amount",o)):o>t&&(d="应付:"+o+"雪球币，帐号余额:"+t+"雪球币，请先购买雪球币",e.addClass("warn"),s.addClass("disabled")),e.text(d).show()}):(d="输入数量错误，请输入整数",e.addClass("warn"),s.addClass("disabled"),e.text(d).show())):(e.text("").hide(),s.addClass("disabled"),s.data("amount",0),!1)}),i.find(".btn-donate").on("click",function(t){t.preventDefault();var s=$(this),e=s.data("amount");if(s.hasClass("disabled")||0===s.data("amount"))return!1;var d=function(){$.get("/c/donate/session",function(t){var s=t.toString();$.post("/c/donate",{to_id:a.id,to_type:a.type,amount:e,session_token:s},function(a){n(e,a)})})};if(s.addClass("disabled"),s.hasClass("validate")){var i=$("#donate-wrap .tip"),o="";i.hide(),e&&/^[1-9]\d*$/.test(e)?e>=5e4?(o="赞助数额不能超过50000雪球币",i.addClass("warn"),i.text(o).show()):$.post("/c/balance",function(a){var t=a.snow_coin;e>t?(o="应付:"+e+"雪球币，帐号余额:"+t+"雪球币，请先购买雪球币",i.addClass("warn"),i.text(o).show()):d&&"function"==typeof d&&d()}):(o="输入数量错误，请输入整数",i.addClass("warn"),i.text(o).show())}else d();return!1}),i.find(".btn-confirm").on("click",function(t){t.preventDefault();var s=$(this);if(s.hasClass("disabled"))return!1;s.addClass("disabled");var e=i.find(".btn-donate").data("amount"),d=$.trim(i.find(".pwd").val());return d=o.encryPw(d),$.get("/c/donate/session",function(t){var s=t.toString();$.post("/c/donate",{to_id:a.id,to_type:a.type,amount:e,password:d,session_token:s},function(a){n(e,a)})}),!1}),i.find(".pwd").on("keyup",function(a){13==a.keyCode&&i.find(".btn-confirm").trigger("click")}),i.find(".btn-recharge").on("click",function(){$(".bd-wrap").hide(),$("#recharge-wrap").show()}),i.find(".btn-done").on("click",function(a){a.preventDefault(),$("#recharge-wrap").hide(),$("#donate-wrap").show();var t=$("#donate-wrap .on");return t.length&&(t.is(".item-custom")?t.find(".coin-amount").trigger("keyup"):t.trigger("click")),!1}),i.find(".btn-share").on("click",function(t){t.preventDefault(),a.amount=i.find(".btn-donate").data("amount");var n="";if(i.dialog("close"),"comment"==a.type){var s="分享";n=e(a),r(s,n)}else n="我刚赞助了这篇帖子 "+a.amount+" 雪球币，也推荐给你。",l(a.status,"",n);return!1}),i.find(".pwd").on("focus",function(){var a=$(this),t=a.parents(".bd-wrap"),n=t.find(".warn");n.hide(),i.find(".btn-confirm").removeClass("disabled")}),i}},n.exports=t=function(a,t){return new i(a,t)}});